---
date_created: Monday, July 1st 2024, 10:42:58 pm
date_updated: Saturday, February 8th 2025, 10:45:25 am
title: 02 .WorkManageråº”ç”¨åœºæ™¯å’Œæµ‹è¯•
author: hacket
categories:
  - Android
category: Jetpack
tags: [Jetpack, WorkManager]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
date created: 2024-04-17 16:16
date updated: 2024-12-24 00:32
aliases: [WorkManager]
linter-yaml-title-alias: WorkManager
---

# WorkManager

## å¦‚ä½•æµ‹è¯• WorkManager

### REQUEST_DIAGNOSTICS

```shell
adb shell am broadcast -a 'androidx.work.diagnostics.REQUEST_DIAGNOSTICS' -p 'ai.me.hacket.AppWidgets'
```

### Background Task Inspector (API 26)

**è·¯å¾„ï¼š**
`View â†’ Tool Window â†’ App Inspection â†’ Background Task Inspector`

![image.png|500](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/20240628144309.png)

**ä½¿ç”¨æ¡ä»¶ï¼š**

- WorkManager åº“åœ¨ 2.5.0 åŠä»¥ä¸Š
- API 26 åŠä»¥ä¸Š
- **ä¸è¶³ï¼š** éœ€è¦ APP è¿›ç¨‹å­˜æ´»

![image.png|1500](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/20240628162626.png)

#### Task Details

![image.png|700](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/20240628162719.png)

- **Descriptionï¼š** æ­¤éƒ¨åˆ†åˆ—å‡ºäº†å·¥ä½œç¨‹åºç±»åç§°ï¼Œä»¥åŠåˆ†é…çš„ tag å’Œå·¥ä½œç¨‹åºçš„ UUIDã€‚
- **Executionï¼š** æ­¤éƒ¨åˆ†æ˜¾ç¤ºå·¥ä½œçº¿ç¨‹çš„çº¦æŸï¼ˆå¦‚æœæœ‰ï¼‰ã€è¿è¡Œé¢‘ç‡å’ŒçŠ¶æ€ï¼Œä»¥åŠå“ªä¸ªç±»åˆ›å»ºäº†å·¥ä½œçº¿ç¨‹å¹¶å°†å…¶æ’é˜Ÿã€‚
- **WorkContinuationï¼š** æ­¤éƒ¨åˆ†æ˜¾ç¤ºå·¥ä½œäººå‘˜åœ¨å·¥ä½œé“¾ä¸­çš„ä½ç½®ã€‚è¦æŸ¥çœ‹å·¥ä½œé“¾ä¸­å¦ä¸€ä¸ªå·¥ä½œäººå‘˜çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å•å‡»å…¶ UUIDã€‚
- **Resultsï¼š** æ­¤éƒ¨åˆ†æ˜¾ç¤ºæ‰€é€‰å·¥ä½œå™¨çš„å¼€å§‹æ—¶é—´ã€é‡è¯•æ¬¡æ•°å’Œè¾“å‡ºæ•°æ®ã€‚

#### Cancel workers

è¦åœæ­¢å½“å‰æ­£åœ¨è¿è¡Œæˆ–æ’é˜Ÿçš„å·¥ä½œçº¿ç¨‹ï¼Œè¯·é€‰æ‹©è¯¥å·¥ä½œçº¿ç¨‹å¹¶ä»å·¥å…·æ ä¸­å•å‡» " å–æ¶ˆé€‰å®šçš„å·¥ä½œçº¿ç¨‹Â ![|20](https://developer.android.com/static/studio/images/app-inspection/task_inspector_stop_button.png)Â "ã€‚

#### View Graph View

ç”±äº `Workers` å¯ä»¥é“¾æ¥åœ¨ä¸€èµ·ï¼Œå› æ­¤æœ‰æ—¶å°†å·¥ä½œäººå‘˜ä¾èµ–å…³ç³»å¯è§†åŒ–ä¸ºå›¾è¡¨å¾ˆæœ‰ç”¨ã€‚è¦æŸ¥çœ‹å·¥ä½œå™¨é“¾çš„å¯è§†åŒ–è¡¨ç¤ºï¼Œè¯·ä»è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå·¥ä½œå™¨ï¼Œç„¶åå•å‡»å·¥å…·æ ä¸­çš„æ˜¾ç¤ºå›¾å½¢è§†å›¾Â ![|20](https://developer.android.com/static/studio/images/app-inspection/task_inspector_graph_view.png)Â ã€‚å›¾ä¸­ä»…ç»˜åˆ¶äº†å·¥äººã€‚

![](https://developer.android.com/static/studio/images/inspect/worker-graph-view.png)

é€šè¿‡è¯¥å›¾è¡¨ï¼Œæ‚¨å¯ä»¥å¿«é€ŸæŸ¥çœ‹å·¥ä½œäººå‘˜ä¹‹é—´çš„å…³ç³»å¹¶ç›‘æ§ä»–ä»¬åœ¨å¤æ‚çš„é“¾æ¥å…³ç³»ä¸­çš„è¿›åº¦ã€‚è¦è¿”å›åˆ—è¡¨è§†å›¾ï¼Œè¯·å•å‡» " æ˜¾ç¤ºåˆ—è¡¨è§†å›¾Â ![|20](https://developer.android.com/static/studio/images/app-inspection/task_inspector_list_view.png)Â "ã€‚

#### View and inspect Jobs, Alarms, and Wakelocks

`Background Task Inspector` è¿˜å¯ä»¥è®©æ‚¨æ£€æŸ¥åº”ç”¨ç¨‹åºçš„ `jobs`ã€`alarms` å’Œ `wakelocks`ã€‚æ¯ç§ç±»å‹çš„å¼‚æ­¥ä»»åŠ¡éƒ½æ˜¾ç¤ºåœ¨æ£€æŸ¥å™¨é€‰é¡¹å¡ä¸­ç›¸åº”çš„æ ‡é¢˜ä¸‹ï¼Œè®©æ‚¨å¯ä»¥è½»æ¾ç›‘æ§å…¶çŠ¶æ€å’Œè¿›åº¦ã€‚

ä¸ `worker` ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥é€‰æ‹© `job`ã€`alarm` æˆ– `wakelock` ä»¥åœ¨**Task Details**é¢æ¿ä¸­æ£€æŸ¥å…¶è¯¦ç»†ä¿¡æ¯ã€‚

![](https://developer.android.com/static/studio/images/inspect/background-task-inspector.png)

### å¼€å¯ Logging

[è°ƒè¯• WorkManager Â |Â  Background work Â |Â  Android Developers](https://developer.android.com/develop/background-work/background-tasks/testing/persistent/debug)

- è‡ªå®šä¹‰ WorkManager åˆå§‹åŒ–ï¼Œå¼€å¯ log
- è¿‡æ»¤ log tag: `WM-`

### adb dump

ä½¿ç”¨ `adb` è·å–æ›´å¤šå…³äº Android 6.0 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šçš„ job scheduling çš„ä¿¡æ¯ã€‚è¿è¡Œå‘½ä»¤ "`adb shell dumpsys jobscheduler`" ä»¥æŸ¥çœ‹åˆ†é…ç»™æ‚¨çš„ package çš„ job åˆ—è¡¨ã€‚

```shell
adb shell dumpsys jobscheduler
```

ç»“æœï¼š

```shell
# ... å•ä¸ªjobä¿¡æ¯
JOB #u0a311/156: cebade6 com.zzkko/androidx.work.impl.background.systemjob.SystemJobService
    u0a311 tag=*job*/com.zzkko/androidx.work.impl.background.systemjob.SystemJobService#156
    Source: uid=u0a311 user=0 pkg=com.zzkko
    JobInfo:
      Service: com.zzkko/androidx.work.impl.background.systemjob.SystemJobService
      Priority: 300 [DEFAULT]
      Requires: charging=false batteryNotLow=false deviceIdle=false
      Extras: mParcelledData.dataSize=180
      Minimum latency: +23h59m59s975ms
      Backoff: policy=1 initial=+30s0ms
      Has early constraint
    Required constraints: TIMING_DELAY UID_NOT_RESTRICTED [0x80100000]
    Preferred constraints:
    Dynamic constraints:
    Satisfied constraints: DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA UID_NOT_RESTRICTED [0xb500000]
    Unsatisfied constraints: TIMING_DELAY [0x80000000]
    Constraint history:
      -1m24s245ms = BACKGROUND_NOT_RESTRICTED [0x400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED [0x2400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED WITHIN_QUOTA [0x3400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA [0xb400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA UID_NOT_RESTRICTED [0xb500000]
    Tracking: TIME QUOTA UID_RESTRICT
    Implicit constraints:
      readyNotDozing: true
      readyNotRestrictedInBg: true
      readyComponentEnabled: true
    Started with foreground flag: false
    Standby bucket: ACTIVE
    Enqueue time: -1m24s245ms
    Run time: earliest=+23h58m35s730ms, latest=none, original latest=none
    Restricted due to: none.
    Ready: false (job=false user=true !restricted=true !pending=true !active=true !backingup=true comp=true)
# ...
```

### Tests å•å…ƒæµ‹è¯•

- [ä½¿ç”¨ WorkManager è¿›è¡Œé›†æˆæµ‹è¯• Â |Â  Background work Â |Â  Android Developers](https://developer.android.com/develop/background-work/background-tasks/testing/persistent/integration-testing)
- [æµ‹è¯• Worker å®ç° Â |Â  Background work Â |Â  Android Developers](https://developer.android.com/develop/background-work/background-tasks/testing/persistent/worker-impl)

### å®šåˆ¶ ROM?

å»æ‰ 15 min çš„é™åˆ¶ï¼Ÿ

# WorkManager åº”ç”¨

## one time work ä¸€æ¬¡ä»»åŠ¡

### Worker

æ¨¡æ‹Ÿå›¾ç‰‡ä¸Šä¼ çš„ä¸€æ¬¡æ€§ä»»åŠ¡ï¼š

å®šä¹‰ä¸€ä¸ª UploadWorkerï¼š

```kotlin
class UploadWorker(context: Context, workerParams: WorkerParameters) :
    Worker(context, workerParams) {
    override fun doWork(): Result {
        // Do the work here--in this case, upload the images.
        "WorkManager UploadWorker doWork start".logi()
        uploadImages()

        // Indicate whether the task finished successfully with the Result
        "WorkManager UploadWorker doWork end".logw()
        return Result.success()
    }

    private fun uploadImages() {
        LogUtils.logi("hacket.WorkManager", "uploadImages", "æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡æ“ä½œ sleep 10000 start")
        SystemClock.sleep(10000)
        LogUtils.logw("hacket.WorkManager", "uploadImages", "æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡æ“ä½œå®Œæˆ end")
    }
}
```

```kotlin
val uploadWorkRequest = OneTimeWorkRequestBuilder<UploadWorker>()
	.addTag("hello_world")
	.setInitialDelay(10, TimeUnit.SECONDS)
	.build()
val uuid = uploadWorkRequest.id
WorkManager
	.getInstance(context)
	.enqueue(uploadWorkRequest)
```

è§‚å¯Ÿ work çŠ¶æ€ï¼Œå¯é€šè¿‡ `id` æˆ– `tag`ï¼š

```kotlin
WorkManager.getInstance(this)  
    .getWorkInfoByIdLiveData(uuid)  
    .observe(this) { workInfo ->  
        if (workInfo != null) {  
            // ...
        }  
    }  
  
WorkManager.getInstance(this).getWorkInfosByTagLiveData("hello_world")  
    .observe(this) { workInfos ->  
        workInfos.forEach {  
            // ... 
        }  
    }
```

### CoroutineWork

```kotlin
class UploadCoroutineWorker(appContext: Context, params: WorkerParameters) : CoroutineWorker(
    appContext,
    params
) {
    override suspend fun doWork(): Result {
        // Do the work here--in this case, upload the images.
        "[$TAG]UploadWorker doWork start".logi()
        uploadImages()

        // Indicate whether the task finished successfully with the Result
        "[$TAG]UploadWorker doWork end".logw()
        return Result.success()
    }
    private suspend fun uploadImages() {
        // åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± 
        val threadPool = Executors.newFixedThreadPool(4)
        // ä»çº¿ç¨‹æ± åˆ›å»ºä¸€ä¸ªCoroutineDispatcher
        val customDispatcher = threadPool.asCoroutineDispatcher()
        // é»˜è®¤æ˜¯Dispatchers.default()
        withContext(customDispatcher) {
	        // åˆ‡æ¢çº¿ç¨‹åˆ°pool-10-thread-1
            LogUtils.logd(
                "hacket.WorkManager",
                "uploadImages",
                "[$TAG]withContext(IO) æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡æ“ä½œ delay 5000 start"
            )
        }
        delay(5_000L)
        LogUtils.logd("hacket.WorkManager", "uploadImages", "[$TAG]æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡æ“ä½œå®Œæˆ end")
        
    }
}
```

æ·»åŠ çº¦æŸæ¡ä»¶ï¼š

```kotlin
val constraints = Constraints.Builder()
//     .setRequiresDeviceIdle(true) // è®¾å¤‡ç©ºé—²ï¼Œè®¾ç½®äº†è¯¥é¡¹ï¼Œå°±ä¸èƒ½è®¾ç½®setBackoffCriteria
	.setRequiresCharging(true) // å……ç”µ
	.setRequiresBatteryNotLow(true) // ä¸æ˜¯ä½ç”µé‡
	.setRequiresStorageNotLow(true) // ä¸æ˜¯ä½å­˜å‚¨ç©ºé—´
	.setRequiredNetworkType(NetworkType.NOT_ROAMING) // ä¸æ˜¯æ¼«æ¸¸ç½‘ç»œç±»å‹
	.build()
val uploadWorkRequest = OneTimeWorkRequestBuilder<UploadCoroutineWorker>()
	.setConstraints(constraints)
	.addTag("hello_world_coroutine")
	.setInitialDelay(10, TimeUnit.SECONDS)
	.build()
lastUuid2 = uploadWorkRequest.id
WorkManager
	.getInstance(context)
	.enqueue(uploadWorkRequest)
```

### RxWorker

```kotlin
class UploadRxWorker(appContext: Context, workerParams: WorkerParameters) : RxWorker(
    appContext,
    workerParams
) {
    companion object {
        private const val TAG = "rx";
    }

    override fun createWork(): Single<Result> {
        return Single.create { emitter ->
            // Do the work here--in this case, upload the images.
            "[$TAG]UploadWorker doWork start delay 5000ms".logd()
            Thread.sleep(5_000L)

            // Indicate whether the task finished successfully with the Result
            "[$TAG]UploadWorker doWork end".logi()
            emitter.onSuccess(Result.success())
        }.subscribeOn(Schedulers.io())
    }
}
```

## Work chain demos

```kotlin
val continuation: WorkContinuation
continuation = WorkManager.getInstance(context)  
    .beginUniqueWork(  
        Constants.IMAGE_MANIPULATION_WORK_NAME,  
        ExistingWorkPolicy.REPLACE,  
        OneTimeWorkRequest.from(CleanupWorker::class.java)  
    ).thenMaybe<WaterColorFilterWorker>(waterColor)  
    .thenMaybe<GrayScaleFilterWorker>(grayScale)  
    .thenMaybe<BlurEffectFilterWorker>(blur)  
    .then(  
        if (save) {  
            workRequest<SaveImageToGalleryWorker>(tag = Constants.TAG_OUTPUT)  
        } else /* upload */ {  
            workRequest<UploadWorker>(tag = Constants.TAG_OUTPUT)  
        }  
    )
/**  
 * Applies a [ListenableWorker] to a [WorkContinuation] in case [apply] is `true`. */private inline fun <reified T : ListenableWorker> WorkContinuation.thenMaybe(  
    apply: Boolean  
): WorkContinuation {  
    return if (apply) {  
        then(workRequest<T>())  
    } else {  
        this  
    }  
}  
  
/**  
 * Creates a [OneTimeWorkRequest] with the given inputData and a [tag] if set. */private inline fun <reified T : ListenableWorker> workRequest(  
    inputData: Data = imageInputData,  
    tag: String? = null  
) =  
    OneTimeWorkRequestBuilder<T>().apply {  
        setInputData(inputData)  
        setExpedited(OutOfQuotaPolicy.RUN_AS_NON_EXPEDITED_WORK_REQUEST)  
        if (!tag.isNullOrEmpty()) {  
            addTag(tag)  
        }  
}.build()
```

[architecture-components-samples/WorkManagerSample at main Â· android/architecture-components-samples Â· GitHub](https://github.com/android/architecture-components-samples/tree/main/WorkManagerSample)

## å¤šè¿›ç¨‹ WorkManager å®˜æ–¹ samples

[architecture-components-samples/WorkManagerMultiprocessSample at main Â· android/architecture-components-samples Â· GitHub](https://github.com/android/architecture-components-samples/tree/main/WorkManagerMultiprocessSample)

# åº”ç”¨åœºæ™¯

## Upload log

Uploading logs ğŸ—³ -> Maybe you want to get some user's log every day at 12.00 am. Work manager is suitable for that

## äº‘ç›˜åŒæ­¥åŠŸèƒ½

## ç›´æ’­/è¯­éŸ³ APP çš„ç¤¼ç‰©ä¸‹è½½

ç¤¼ç‰©ä¸‹è½½ï¼Œå¼„ä¸ªå®šæ—¶ workï¼Œæ¯å¤©åŒæ­¥ 1~2 æ¬¡

## è‡ªæœ‰åŸ‹ç‚¹çš„ä¸ŠæŠ¥

è‡ªå·±é‡‡é›†çš„ä¸€äº›åŸ‹ç‚¹ï¼Œå®šæ—¶ä¸ŠæŠ¥

## å›¾ç‰‡ä¸Šä¼ 

### å¤´åƒçš„ä¸Šä¼ 

ç”¨æˆ·å¤´åƒä¸Šä¼ 

### å›¾ç‰‡çš„å¤„ç†

Applying filters to images and saving the image ğŸ—‚ -> Suppose that you work at an AI Company and you want to filter the image but request-response get fails, work manager is retry it at later time

1. å›¾ç‰‡çš„ blur worker
2. å›¾ç‰‡çš„ gray worker
3. å›¾ç‰‡ water worker
4. å›¾ç‰‡ä¸Šä¼  worker

ä¸€ç³»åˆ— worker ç»„æˆ chain

å®˜æ–¹ chain ç¤ºä¾‹ï¼š[architecture-components-samples/WorkManagerSample at main Â· android/architecture-components-samples Â· GitHub](https://github.com/android/architecture-components-samples/tree/main/WorkManagerSample)

## App Widget

App Widget çš„å‘¨æœŸæ€§æ›´æ–°æ•°æ®ï¼Œé€šè¿‡ WorkManager æ¥æ›´æ–°

## Google Play Cubes

å‘¨æœŸæ€§ä»»åŠ¡æ›´æ–°æ•°æ®

# WorkManager å‘

## æ³¨æ„

1. æ²¡æœ‰æ·»åŠ  tag çš„ schedule wokerï¼Œæ¯æ¬¡æ·»åŠ éƒ½æ˜¯æ–°çš„ worker

## Oppo å·¥ç¨‹å¸ˆè®¤ä¸ºè¿™ä¸ª Api è¿‡äºè€—ç”µï¼Œäºæ˜¯å±è”½æ‰äº†è¿™ä¸ª Api çš„åŠŸèƒ½ (å¾…éªŒè¯)

è¯¦æƒ…è¯·å‚è€ƒï¼š[OPPOç¤¾åŒº](https://bbs.coloros.com/thread-174655-1-1.html)

è§£å†³ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

1. å½»åº•æ”¾å¼ƒä½¿ç”¨ `WorkManager` è¿™ä¸ª apiï¼Œä½¿ç”¨ Alarm manager ä»£æ›¿
2. éƒ¨åˆ†æ”¾å¼ƒï¼Œå¯ä»¥åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ£€æµ‹æ‰‹æœºå“ç‰Œæ˜¯ `Oppo` çš„è¯å°±ç”¨ Alarm manager ä»£æ›¿ï¼Œå¦åˆ™ä½¿ç”¨ `WorkManager` ä»£æ›¿ï¼ŒæŸ¥è¯¢ `Oppo` æ‰‹æœºçš„ rom çš„æ–¹å¼æ˜¯æŸ¥è¯¢ `build.prop` æ˜¯å¦æœ‰ `ro.build.version.opporom` å±æ€§

## è¿›ç¨‹æ€æ­»æ‰§è¡Œæƒ…å†µ

- `WorkManager`Â è™½ç„¶åœ¨è®¾è®¡çš„æ—¶å€™æ˜¯ä¸ºäº†åœ¨ App æ²¡è¿è¡Œçš„æ—¶å€™ä¹Ÿèƒ½è¿è¡Œ Worker, ä½†æ˜¯ç›®å‰ä» Google Issue Tracker ä¸Šçš„ä¿¡æ¯æ¥çœ‹, ä»¥ä¸‹å‡ ç§æƒ…å†µæ€æ‰åä»»åŠ¡çš„å­˜æ´»æƒ…å†µæ˜¯è¿™æ ·çš„:

  1. ä»ä»»åŠ¡ç®¡ç†å™¨ (æœ€è¿‘ä½¿ç”¨) å…³æ‰: åŸç”Ÿçš„ Android ä¸Š Worker ä»ç„¶ä¼šè¿è¡Œ, ä½†æ˜¯åœ¨ [æŸäº›æŠŠè¿™ç§æ“ä½œå½“åšå¼ºåˆ¶åœæ­¢çš„å‚å•†](https://issuetracker.google.com/issues/110745313)Â æˆ–Â [ä¸€äº›ä¸­å›½å‚å•†](https://issuetracker.google.com/issues/113676489)Â çš„æœºå‹ä¸Š, Worker è¦ç­‰åˆ°ä¸‹æ¬¡æ‰“å¼€ App æ‰ä¼šè¿è¡Œ.
  2. é‡å¯æ‰‹æœº (Worker è¿è¡Œä¸­çš„çŠ¶æ€): é‡å¯å Worker ä¼šç»§ç»­è¿è¡Œ.
  3. App ä¿¡æ¯ -> å¼ºåˆ¶å…³é—­: Worker ä¼šå†ä¸‹æ¬¡æ‰“å¼€ App çš„æ—¶å€™è¿è¡Œ.
  4. é‡å¯æ‰‹æœº (App è¢«å¼ºåˆ¶å…³é—­äº†): Worker ä¼šå†ä¸‹æ¬¡æ‰“å¼€ App çš„æ—¶å€™è¿è¡Œ.

### ç°çŠ¶

åœ¨è°·æ­ŒåŸç”Ÿæ‰‹æœºä¸Šï¼Œå³ä½¿ä½ æ€æ­»è¿›ç¨‹ï¼Œè¿™ä¸ª api ä¹Ÿä¼šä¸€ç›´æ‰§è¡Œä½ è®¾ç½®çš„å®šæ—¶ä»»åŠ¡ï¼Œè€Œåœ¨å›½äº§äº”å¤§å‚å•†çš„æ‰‹æœºä¸Šåˆ™ä¸ç„¶ï¼Œä¼šè·Ÿéšè¿›ç¨‹è¢«æ€æ­»ã€‚

- ä¸€åŠ  Ace2V æ‰‹æœºå›½å†…ç‰ˆï¼Œå¼€å¯ WorkManager ä»»åŠ¡åï¼Œapp è¿›ç¨‹æ­»äº†ï¼ŒWorker ä¸ä¼šè¿è¡Œäº†ï¼Œç­‰è¿›ç¨‹æ´»äº† Worker ç»§ç»­æ‰§è¡Œã€‚

### æŸ¥çœ‹ APP è¿›ç¨‹æ˜¯å¦å­˜æ´»

å‘½ä»¤ï¼š`adb shell ps -A | grep com.example.app`

å¦‚æœå­˜åœ¨è¾“å‡ºå°±è¡¨ç¤ºè¯¥è¿›ç¨‹å­˜æ´»ç€

ç¤ºä¾‹ï¼š

```shell
$adb shell ps -ef | grep me.hacket
u0_a406      12760 11830 0 10:01:01 136:0 00:00:00 install_server-7cce5689 ai.me.hacket.AppWidgets
u0_a406      13413   871 19 10:14:31 ?    00:00:00 ai.me.hacket.AppWidgets
```

**å„åˆ—çš„è§£é‡Šï¼š**

1. **USER**ï¼š`u0_a406`
   - è¿è¡Œæ­¤è¿›ç¨‹çš„ç”¨æˆ·ã€‚ä¾‹å¦‚ï¼Œ`u0_a406`Â è¡¨ç¤ºç”¨æˆ· 406ã€‚
   - `u0`Â ä»£è¡¨ç”¨æˆ·ç©ºé—´ï¼Œ`a406`Â ä»£è¡¨ç”¨æˆ· IDã€‚
2. **PID**ï¼š`13413`
   - è¿›ç¨‹ IDã€‚è¿™æ˜¯è¯¥è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ä¾‹å¦‚ï¼Œ`13413`Â æ˜¯è¯¥è¿›ç¨‹çš„ IDã€‚
3. **PPID**ï¼š`871`
   - çˆ¶è¿›ç¨‹ IDã€‚è¡¨ç¤ºå“ªä¸ªè¿›ç¨‹å¯åŠ¨äº†æ­¤è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œ`871`Â æ˜¯è¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ IDã€‚
4. **PRI**ï¼š`19`
   - è¿›ç¨‹ä¼˜å…ˆçº§ã€‚ä¼˜å…ˆçº§é€šå¸¸å†³å®šäº†è°ƒåº¦ç¨‹åºåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸­å¦‚ä½•è°ƒåº¦è¯¥è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œ`19`Â æ˜¯è¯¥è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚
5. **STIME**ï¼š`10:14:31`
   - è¯¥è¿›ç¨‹çš„å¯åŠ¨æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ`10:14:31`Â è¡¨ç¤ºè¯¥è¿›ç¨‹åœ¨ 10:14:31 å¯åŠ¨ã€‚
6. **TTY**ï¼š`?`
   - ç»ˆç«¯ç±»å‹ã€‚`?`Â è¡¨ç¤ºè¯¥è¿›ç¨‹æ²¡æœ‰ä¸ç‰¹å®šç»ˆç«¯å…³è”ã€‚
7. **TIME**ï¼š`00:00:00`
   - è¿›ç¨‹å ç”¨çš„æ€» CPU æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ`00:00:00`Â è¡¨ç¤ºè¯¥è¿›ç¨‹å‡ ä¹æ²¡æœ‰ä½¿ç”¨ CPU æ—¶é—´ã€‚
8. **CMD**ï¼š`ai.me.hacket.AppWidgets`
   - è¿›ç¨‹å‘½ä»¤æˆ–è¿›ç¨‹åç§°ã€‚ä¾‹å¦‚ï¼Œ`ai.me.hacket.AppWidgets`Â æ˜¯è¿›ç¨‹åç§°æˆ–åº”ç”¨åŒ…åã€‚

### æ“ä½œå¯¹è¿›ç¨‹çš„å½±å“

| æ“ä½œ                     | è®¾å¤‡      | è¿›ç¨‹å­˜æ´» | Worker ä»»åŠ¡æ‰§è¡Œ | åˆ›å»ºæ–°çš„è¿›ç¨‹  |
| :--------------------- | :------ | :--- | ----------- | ------- |
| æœ€è¿‘ä»»åŠ¡åˆ—è¡¨åˆ’æ‰               | Pixel 6 | ä¸å­˜æ´»  | æ­£å¸¸æ‰§è¡Œ        | åˆ›å»ºæ–°çš„è¿›ç¨‹  |
| APP Info ç•Œé¢ Force Stop | Pixel 6 | ä¸å­˜æ´»  | ä¸æ‰§è¡Œ         | ä¸åˆ›å»ºæ–°çš„è¿›ç¨‹ |
| adb kill               | Pixel 6 |      |             |         |
|                        |         |      |             |         |

### WorkManager å…¥é˜Ÿ App è¢«æ€æ­»ï¼Œä»»åŠ¡ä¸æ‰§è¡Œ

**ä»»åŠ¡åˆ›å»ºå¹¶ä¸”å…¥é˜Ÿå,app è¢«åå°æ¸…ç†äº†,ä»»åŠ¡ä¸ä¼šæ‰§è¡Œ. ä½†æ˜¯åœ¨ app é‡æ–°å¯åŠ¨å,åªè¦å®šæ—¶æ—¶é—´å·²ç»åˆ°è¾¾,ä»»åŠ¡å°±ä¼šåœ¨ app å¯åŠ¨çš„æ—¶å€™ç«‹åˆ»æ‰§è¡Œ.**

## è¦é¿å¼€ queue é‡Œé¢å‡ºç° 100 ä¸ªå¾…è°ƒåº¦çš„ job çš„ case

> éœ€è¦æ³¨æ„çš„æ˜¯é˜Ÿåˆ—é‡Œé¢ä»»åŠ¡ï¼ˆè¿˜åœ¨ç­‰å¾…è°ƒåº¦æœªæ‰§è¡Œçš„é‚£ç§ï¼‰ä¸èƒ½è¶…è¿‡ 100 ä¸ªï¼Œä¸ç„¶ä¼š crashï¼Œè¿™æ˜¯ workmanager ä»£ç çš„é™åˆ¶

## å›½å†…æ‰‹æœº WorkManager ä¸è°ƒåº¦æƒ…å†µ

1. ä»ä»»åŠ¡ç®¡ç†å™¨ (æœ€è¿‘ä½¿ç”¨) å…³æ‰: åŸç”Ÿçš„ Android ä¸Š Worker ä»ç„¶ä¼šè¿è¡Œ, ä½†æ˜¯åœ¨ [æŸäº›æŠŠè¿™ç§æ“ä½œå½“åšå¼ºåˆ¶åœæ­¢çš„å‚å•†](https://issuetracker.google.com/issues/110745313)Â æˆ–Â [ä¸€äº›ä¸­å›½å‚å•†](https://issuetracker.google.com/issues/113676489)Â çš„æœºå‹ä¸Š [are the Chinese manufacturers (Huawei, Oppo, Xiaomi...) supported? [113676489] - Issue Tracker](https://issuetracker.google.com/issues/113676489?pli=1), Worker è¦ç­‰åˆ°ä¸‹æ¬¡æ‰“å¼€ App æ‰ä¼šè¿è¡Œ.
2. é‡å¯æ‰‹æœº (Worker è¿è¡Œä¸­çš„çŠ¶æ€): é‡å¯å Worker ä¼šç»§ç»­è¿è¡Œ.
3. App ä¿¡æ¯ -> å¼ºåˆ¶å…³é—­: Worker ä¼šå†ä¸‹æ¬¡æ‰“å¼€ App çš„æ—¶å€™è¿è¡Œ.
4. é‡å¯æ‰‹æœº (App è¢«å¼ºåˆ¶å…³é—­äº†): Worker ä¼šå†ä¸‹æ¬¡æ‰“å¼€ App çš„æ—¶å€™è¿è¡Œ.

### ä¸‰æ˜Ÿæ‰‹æœº job æœªè°ƒåº¦

```shell
  JOB #u0a311/156: cebade6 com.zzkko/androidx.work.impl.background.systemjob.SystemJobService
    u0a311 tag=*job*/com.zzkko/androidx.work.impl.background.systemjob.SystemJobService#156
    Source: uid=u0a311 user=0 pkg=com.zzkko
    JobInfo:
      Service: com.zzkko/androidx.work.impl.background.systemjob.SystemJobService
      Priority: 300 [DEFAULT]
      Requires: charging=false batteryNotLow=false deviceIdle=false
      Extras: mParcelledData.dataSize=180
      Minimum latency: +23h59m59s975ms
      Backoff: policy=1 initial=+30s0ms
      Has early constraint
    Required constraints: TIMING_DELAY UID_NOT_RESTRICTED [0x80100000]
    Preferred constraints:
    Dynamic constraints:
    Satisfied constraints: DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA UID_NOT_RESTRICTED [0xb500000]
    Unsatisfied constraints: TIMING_DELAY [0x80000000]
    Constraint history:
      -1m24s245ms = BACKGROUND_NOT_RESTRICTED [0x400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED [0x2400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED WITHIN_QUOTA [0x3400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA [0xb400000]
      -1m24s245ms = DEVICE_NOT_DOZING BACKGROUND_NOT_RESTRICTED TARE_WEALTH WITHIN_QUOTA UID_NOT_RESTRICTED [0xb500000]
    Tracking: TIME QUOTA UID_RESTRICT
    Implicit constraints:
      readyNotDozing: true
      readyNotRestrictedInBg: true
      readyComponentEnabled: true
    Started with foreground flag: false
    Standby bucket: ACTIVE
    Enqueue time: -1m24s245ms
    Run time: earliest=+23h58m35s730ms, latest=none, original latest=none
    Restricted due to: none.
    Ready: false (job=false user=true !restricted=true !pending=true !active=true !backingup=true comp=true)
```

ç”¨çš„å•æ¬¡å‘å¸ƒï¼š

```kotlin
private fun queueOneTimeEngageServiceWorker(  
	workerName: String,  
	publishType: String,  
	context: Context  
) {  
	val workRequest =  
		OneTimeWorkRequestBuilder<EngageServiceWorker>()  
			.setInputData(workDataOf(PUBLISH_TYPE to publishType))  
//                .setExpedited(OutOfQuotaPolicy.RUN_AS_NON_EXPEDITED_WORK_REQUEST)  
			.build()  
	L.v(TAG, "queueOneTimeEngageServiceWorker() - $workerName - $publishType")  
	WorkManager.getInstance(context)  
		.enqueueUniqueWork(workerName, ExistingWorkPolicy.REPLACE, workRequest)  
}
```

è§£å†³ï¼šéœ€è¦åŠæ—¶å‘å¸ƒçš„ï¼Œä¸ç”¨ WorkManagerï¼Œåªæœ‰éœ€è¦å®šæ—¶çš„æ‰ç”¨ WorkManager

### ä¸­å›½æ‰‹æœºä¸è°ƒåº¦

- WorkManager ä¸å¤ªå‡†æ—¶ï¼Œå¯èƒ½ä¸€å¤©åªæ‰§è¡Œä¸€æ¬¡ï¼Œå…¨é ç³»ç»Ÿè°ƒåº¦äº†ï¼Œé™¤éè®©ç”¨æˆ·åŒæ„åå°å¯åŠ¨ã€‚
- å½“æˆ‘ä»¬ä»æœ€è¿‘çš„åº”ç”¨ç¨‹åºæ‰˜ç›˜ä¸­æ¸…é™¤è¯¥åº”ç”¨ç¨‹åºæ—¶ï¼ŒAndroid ç³»ç»Ÿä¼šæ€æ­»è¯¥åº”ç”¨ç¨‹åºã€‚å½“æˆ‘ä»¬ä½¿ç”¨ Workmanager å®‰æ’ä»»åŠ¡æ—¶ï¼Œå¦‚æœç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»æœ€è¿‘çš„åº”ç”¨ç¨‹åºä¸­æ¸…é™¤äº†è¯¥åº”ç”¨ç¨‹åºï¼Œåˆ™è¯¥åº”ç”¨ç¨‹åºå°†è¢«ç»ˆæ­¢å¹¶ä¸”æ“ä½œæ— æ³•æ­£å¸¸å·¥ä½œã€‚è¿™ç§æƒ…å†µåªå‘ç”Ÿåœ¨ä¸­æ–‡ ROM ä¸­ã€‚
- æˆ‘ä»¬é‡åˆ°çš„å”¯ä¸€é—®é¢˜æ˜¯ä¸€äº›ä¸­å›½åŸå§‹è®¾å¤‡åˆ¶é€ å•†å°†æ»‘åŠ¨ä»¥ä» " æœ€è¿‘ " ä¸­å…³é—­è§†ä¸ºå¼ºåˆ¶åœæ­¢ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼ŒWorkManager å°†åœ¨ä¸‹æ¬¡åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶é‡æ–°å®‰æ’æ‰€æœ‰å¾…å¤„ç†çš„ä½œä¸šã€‚é‰´äºè¿™æ˜¯ä¸€ç§ CDD è¿è§„ï¼Œè€ƒè™‘åˆ° WorkManager çš„å®¢æˆ·ç«¯åº“ï¼Œå®ƒæ— èƒ½ä¸ºåŠ›ã€‚
- å¦‚æœè®¾å¤‡åˆ¶é€ å•†å†³å®šä¿®æ”¹åŸç”Ÿ Android ä»¥å¼ºåˆ¶åœæ­¢åº”ç”¨ç¨‹åºï¼ŒWorkManager å°†åœæ­¢å·¥ä½œï¼ˆJobSchedulerã€è­¦æŠ¥ã€å¹¿æ’­æ¥æ”¶å™¨ç­‰ä¹Ÿå°†åœæ­¢å·¥ä½œï¼‰ã€‚æ²¡æœ‰åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¸€äº›è®¾å¤‡åˆ¶é€ å•†ä¼šè¿™æ ·åšï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒWorkManager å°†åœæ­¢å·¥ä½œï¼Œç›´åˆ°ä¸‹æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºä¸ºæ­¢ã€‚
- æˆ‘å°è¯•äº†å¾ˆå¤šæ–¹æ³•æ¥åœ¨åº”ç”¨ç¨‹åºè¢«æ€æ­»/ä» Android åå †æ ˆä¸­åˆ é™¤åä¿æŒæœåŠ¡åœ¨åå°è¿è¡Œã€‚æˆ‘å°è¯•è¿‡ AlermManager å’Œå¹¿æ’­æ¥æ”¶å™¨ã€JobScheduler å’Œ WorkManagerã€‚æ‰€æœ‰è¿™äº›åœ¨æŸäº›æ‰‹æœºä¸­éƒ½å¯ä»¥å®Œç¾è¿è¡Œï¼Œä½†åœ¨æŸäº›æ‰‹æœºï¼ˆå…·æœ‰è‡ªå®šä¹‰æ“ä½œç³»ç»Ÿï¼‰ä¸­åˆ™æ— æ³•æ­£å¸¸å·¥ä½œã€‚æˆ‘è¯•å›¾æ‰¾åˆ°ä»»ä½•è§£å†³æ–¹æ¡ˆæˆ–æ›¿ä»£æ–¹æ³•æ¥è§£å†³ä¸Šå‘¨çš„è¿™ä¸ªé—®é¢˜ï¼Œä½†æˆ‘ä»ç„¶æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è§£å†³æ–¹æ¡ˆã€‚è¯·ä¸ºæ­¤æä¾›ä¸€äº›å¸®åŠ©ã€‚
- [are the Chinese manufacturers (Huawei, Oppo, Xiaomi...) supported?](https://issuetracker.google.com/issues/113676489?pli=1)
- [java - Work Manager on chinese ROMs like Xiaomi and oppo, when under battery optimization, increase the scheduled delay of work by several hours - Stack Overflow](https://stackoverflow.com/questions/59906497/work-manager-on-chinese-roms-like-xiaomi-and-oppo-when-under-battery-optimizati)

## WorkManager å‘¨æœŸæ€§ä»»åŠ¡æ‹‰èµ·è¿›ç¨‹

å‘¨æœŸæ€§ä»»åŠ¡ï¼ŒApp æ€æ­»åï¼Œæ‰§è¡Œå‘¨æœŸæ€§ä»»åŠ¡æ—¶ï¼Œä¼šæ‹‰èµ· App è¿›ç¨‹å—ï¼Ÿ

> ä¼šæ‹‰èµ· App çš„è¿›ç¨‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒApplication.onCreate åšäº†å¼‚æ­¥ä»»åŠ¡ï¼Œä½†åœ¨ Worker ä¸­éœ€è¦ä¾èµ–çš„

- [Can an Android Worker run without calling Application.onCreate? - Stack Overflow](https://stackoverflow.com/questions/75554072/can-an-android-worker-run-without-calling-application-oncreate)
