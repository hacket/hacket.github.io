---
banner: 
date_created: Thursday, February 13th 2025, 10:18:31 am
date_updated: Thursday, April 10th 2025, 8:51:08 am
title: Frida
author: hacket
categories:
  - Android进阶
category: 玩机
tags: [玩机, Frida]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
aliases: [Frida]
linter-yaml-title-alias: Frida
---

# Frida

## Frida 环境安装

### frida 、frida-tools

```shell
# 安装frida
pip install frida -i https://pypi.mirrors.ustc.edu.cn/simple/
# 安装frida-tools
pip install frida-tools -i https://pypi.mirrors.ustc.edu.cn/simple/
# 如果报错，需要更新
python -m pip install --upgrade pip
# 如果网络没有问题还是报错，换下一条指令：
python -m pip install -U --force-reinstall pip
## 等待安装frida成功即可

# frida安装成功后的测试指令：
frida help
# 查看frida版本
frida version
```

### frida-server

- frida-server 的 [下载](https://github.com/frida/frida/releases)：要看清楚 frida-server 要往下滑才能看见，（后缀为.xz）我理解的就是类似于二进制
- frida-server 的版本需要和 frida 版本一致
- 使用 adb 命令：如下，我的手机/模拟器就是 x86_64，在去找对应的 frida-server 后缀 x86_64 下载:

```shell
adb shell getprop ro.product.cpu.abi
# arm64-v8a，需要下载64位的版本：frida-server-16.7.3-android-x86_64.xz
```

- **x86 (32-bit)**: `frida-server-*-android-x86.xz`
- **x86_64 (64-bit)**: `frida-server-*-android-x86_64.xz`
- **ARM (32-bit)**: `frida-server-*-android-arm.xz`
- **ARM64**: `frida-server-*-android-arm64.xz`
- 下载后将.xz 解压出来，adb push 到手机上：

```shell
# 解压得到：frida-server-16.7.3-android-x86_64
# adb push; 路径网上大部分都是data/local/tmp，不知道是不是有关系的；如果放到/sdcard/download目录下，chmod 755不生效
adb push ./frida-server-16.7.3-android-x86_64 data/local/tmp

adb shell 
cd /data/local/tmp

# 更改权限可执行
chmod 755 ./frida-server-16.7.3-android-x86_64
```

- 启动 frida-server

```shell
cd /data/tmp/local
./frida-server-16.7.3-android-x86_64

#监听端口
./frida-server-16.7.3-android-x86_64 -l 0.0.0.0:8888
```

**新版 Frida 不需要转发端口**

- 报错

报错 1：[Unable to load SELinux policy from the kernel: Failed to open file “/sys/fs/selinux/policy”: Permission denied · Issue #597 · frida/frida](https://github.com/frida/frida/issues/597)

```
Unable to load SELinux policy from the kernel: Failed to open file ?/sys/fs/selinux/policy?: Permission denied
```

解决 1：需要 su 权限

报错 2：[Unable to save SELinux policy to the kernel: Out of memory · Issue #473 · frida/frida](https://github.com/frida/frida/issues/473)

```
Unable to save SELinux policy to the kernel: Out of memory
```

解决 2：

```shell
su ./frida-server-16.7.3-android-arm64 &
# 加&，表示以后台模式运行
```

- 和 `frida-server` 交互，前提是通过 USB 连接

```shell
frida-ps -U
```

### vscode 配置代码提示

首先安装 [Node.js (nodejs.org)](https://nodejs.org/zh-cn)，新建一个文件夹，在目录下执行下面这条命令。

```shell
npm i @types/frida-gum
```

## Objection

Frida + Objection，动态代码插桩，支持 Hook 方法、监控文件操作、网络请求、加解密函数等。

- **优点**：
	- 无需 Xposed，支持非 Root 设备（部分功能需 Root）。
	- 灵活性强，可编写自定义脚本。
	- Objection 提供简化命令（如 `android hooking watch`）。
[GitHub - sensepost/objection: 📱 objection - runtime mobile exploration](https://github.com/sensepost/objection)

## Frida 使用

### frida-tools 使用

frida tools 主要有**Frida CLI**、**frida-ps**、**frida-trace**、**frida-discover**、**frida-ls-devices**、**frida-kill**等命令工具。

#### frida cli

- _**frida-ls-devices**_
查看电脑连接的设备信息，主要包括**UDID**、**连接方式**、**设备名称**，如下所示
![202504090839860](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/202504100838458.png)

- _**frida-ps -U**_  查看通过 USB 连接的设备上运行的程序
- _**frida-ps -Ua**_ 查看正在运行的应用程序
![202504090840588](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/202504100838464.png)
- _**frida-ps -Uai**_ 查看设备已经安装的应用程序
- `frida-ps -D <UDID>` 通过设备的 UDID 查看设备中应用程序中的 pid、进程名，
- `frida-kill -D <UDID> <pid>`  杀死指定 UDID 的设备的具体进程，pid 为该进程的进程号

## 实战

### Hook 步骤

以 Android 平台为例，了解一下 frida 的工作流程:

- frida-server：运行在安卓端，与电脑端进行通信，接收电脑端的调试请求，并将 JavaScript 编写的 hook 代码注入到目标 app 中。
- 电脑端：与 frida-server 通信，可以使用多种编程语言编写脚本和管理注入过程，最常用的是 Python
- JavaScript 脚本：编写具体的注入和修改逻辑，并通过电脑端提供的环境被推送到 frida-server 中，从而注入到目标 app。

### demo

对此，我们需要建立两个文件，一个 `hook.js` 用于存放具体的修改逻辑，一个 `hook.py` 用于自动管理注入流程，如：在合适的时机自动注入。

- hook.py

```python
import frida
import sys
import time

# 应用包名
app_package_name = 'me.hacket.demos'

# 延迟注入时间（秒），防止dex未加载
delay_time = 2


# hook脚本所在路径
hookJs='hook.js'

def on_message(message, data):
    if message['type'] == 'send':
        print("[*] {0}".format(message['payload']))
    elif message['type'] == 'error':
        print("[!] {0}".format(message['stack']))

# 启动应用程序
device = frida.get_usb_device()
print("Device: %s" % device)
print("app_package_name: %s" % app_package_name)
pid = device.spawn([app_package_name])
print("Pid: %d" % pid)
device.resume(pid)
time.sleep(1)  # 等待应用程序启动

# 延迟注入
print(f"Waiting for {delay_time} seconds before injecting script...")
time.sleep(delay_time)

# 注入脚本
with open(hookJs, 'r',encoding='utf-8') as f:
    script_code = f.read()

session = device.attach(pid)
script = session.create_script(script_code)
script.on('message', on_message)
script.load()
print("[*] Script injected successfully.")
sys.stdin.read()
```

- hook.js

```js
// 从内存中寻找包含android字样的类并打印
Java.perform(function () {
  Java.enumerateLoadedClasses({
    onMatch: function (className) {
      if (className.includes("android")) {
        console.log(className);
      }
    },
    onComplete: function () {
      console.log("Class enumeration complete");
    },
  });
});
```

- 执行 hook

```shell
python hook.py
```

## 报错

### Windows 上报错：need Gadget to attach on jailed

![202504100040649](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/202504100838466.png)

错误显示：问题出在这个 `C:\Users\XXX\AppData\Local\Microsoft\Windows\INetCache\frida\gadget-android-arm64.so` 文件中。

但是当我们去访问这个文件夹时，发现该文件夹不存在

因此我们自己创建这个文件夹：

`C:\Users\XXX\AppData\Local\Microsoft\Windows\INetCache\frida\`

去下载对应版本的： [`gadget-android-arm64.so`](https://github.com/frida/frida/releases)

下载完成后解压，并将文件重命名为 `gadget-android-arm64.so`

放到 `C:\Users\XXX\AppData\Local\Microsoft\Windows\INetCache\frida\gadget-android-arm64.so`

- [frida报错need Gadget....(有效解决方法)\_failed to spawn: need gadget to attach on jailed a-CSDN博客](https://blog.csdn.net/m0_65663088/article/details/135994176)

## Ref

- [Frida 原理及简单使用 - Only-xiaoxiao - 博客园](https://www.cnblogs.com/Only-xiaoxiao/p/17294561.html)
