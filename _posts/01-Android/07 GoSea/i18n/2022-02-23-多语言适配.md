---
banner: 
date_created: Friday, February 23rd 2022, 10:10:45 pm
date_updated: Thursday, September 11th 2025, 11:45:02 pm
title: å¤šè¯­è¨€é€‚é…
author: hacket
categories:
  - Androidè¿›é˜¶
category: å‡ºæµ·
tags: [Androidé€‚é…, å‡ºæµ·, å¤šè¯­è¨€]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
date created: 2024-06-12 15:27
date updated: 2024-12-24 00:35
aliases: [bidi ç®—æ³•ï¼ˆåŒå‘å­—ç¬¦ï¼‰ã€BidiFormatter è¯¦è§£åŠ mashi é€‚é…æ¡ˆä¾‹]
linter-yaml-title-alias: bidi ç®—æ³•ï¼ˆåŒå‘å­—ç¬¦ï¼‰ã€BidiFormatter è¯¦è§£åŠ mashi é€‚é…æ¡ˆä¾‹
---

# bidi ç®—æ³•ï¼ˆåŒå‘å­—ç¬¦ï¼‰ã€BidiFormatter è¯¦è§£åŠ mashi é€‚é…æ¡ˆä¾‹

## Bidi åŸºç¡€

### åŒå‘å­—ç¬¦ç±»å‹

ä¹¦å†™æ–¹å‘æ˜¯å’Œæ–‡å­—ç›¸å…³ï¼Œé˜¿æ‹‰ä¼¯æ–‡å­—ä»å³åˆ°å·¦ï¼Œæ‹‰ä¸æ–‡å­—ä»å·¦åˆ°å³ã€‚å½“äººä»¬åœ¨çº¸ä¸Šä¹¦å†™æ—¶å½“ç„¶ä¼šè®°å¾—è¿™äº›è§„åˆ™ï¼Œé‚£è®¡ç®—æœºæ˜¯å¦‚ä½•çŸ¥é“çš„å‘¢ï¼Ÿå®é™…ä¸Šï¼ŒUnicode å®šä¹‰äº†å®ƒå…¶ä¸­æ¯ä¸ªå­—ç¬¦çš„æ–¹å‘å±æ€§ï¼Œè®¡ç®—æœºå°±æ˜¯æ ¹æ®è¿™ä¸ªæ–¹å‘å±æ€§æ¥åˆ¤æ–­è¯¥æ–‡å­—çš„æ–¹å‘ã€‚<br />Unicode æ–¹å‘å±æ€§åŒ…å«ä¸‰ç§ç±»å‹ï¼šå¼ºå­—ç¬¦ã€å¼±å­—ç¬¦å’Œä¸­æ€§å­—ç¬¦

#### å¼ºå­—ç¬¦

å¤§éƒ¨åˆ†çš„å­—ç¬¦éƒ½å±äºå¼ºå­—ç¬¦ã€‚å®ƒä»¬çš„æ–¹å‘æ€§æ˜¯ç¡®å®šçš„ï¼Œä»å·¦åˆ°å³æˆ–è€…ä»å³åˆ°å·¦ï¼Œå’Œå…¶ä¸Šä¸‹æ–‡çš„ bidi å±æ€§æ— å…³ã€‚å¹¶ä¸”ï¼Œ**å¼ºå­—ç¬¦åœ¨ bidi ç®—æ³•ä¸­å¯èƒ½ä¼šå½±å“å…¶å‰åå­—ç¬¦çš„æ–¹å‘æ€§**ã€‚

1. å·¦åˆ°å³ï¼ˆLTRï¼‰<br />æ‹‰ä¸æ–‡å­— (è‹±æ–‡å­—æ¯)ã€æ±‰å­—
2. å³åˆ°å·¦ï¼ˆRTLï¼‰<br />RTL è¯­è¨€æœ‰ä»¥ä¸‹ 6 ç§ï¼š

| è¯­ç§            | è¯­è¨€ä»£ç  | å›½å®¶      | ç¤ºä¾‹      |
| ------------- | ---- | ------- | ------- |
| é˜¿æ‹‰ä¼¯è¯­          | ar   | Arbic   | Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© |
| æ³¢æ–¯è¯­           | fa   | Persian | ÙØ§Ø±Ø³ÛŒ   |
| å¸Œä¼¯æ¥è¯­          | iw   | Hebrew  | ×¢×‘×¨×™×ª   |
| ä¹Œå°”éƒ½è¯­ï¼ˆå°åº¦ã€å·´åŸºæ–¯å¦ï¼‰ | ur   | Urdu    | Ø§Ø±Ø¯Ùˆ    |
| ç»´å¾å°”è¯­          | -    | Uyghur  | -       |

#### å¼±å­—ç¬¦

å¼±å­—ç¬¦çš„ç‰¹æ€§ï¼Œå®ƒä»¬çš„æ–¹å‘æ˜¯ç¡®å®šçš„ï¼Œä½†å¯¹å…¶å‰åå­—ç¬¦çš„æ–¹å‘æ€§å¹¶ä¸ä¼šäº§ç”Ÿå½±å“ã€‚**æ•°å­—å’Œæ•°å­—ç›¸å…³çš„ä¸€äº›ç¬¦å·**å°±å±äºå¼±å­—ç¬¦ã€‚

1. è¥¿é˜¿æ‹‰ä¼¯æ•°å­— (LTR)ï¼š(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
2. ä¸œé˜¿æ‹‰ä¼¯æ•°å­—ï¼š(Ù â€ - Ù¡â€ - Ù¢â€ - Ù£â€ - Ù¤â€ - Ù¥â€ - Ù¦â€ - Ù§â€ - Ù¨â€ - Ù©)
3. æ³¢æ–¯æ•°å­—ï¼š(Û° - Û± - Û² - Û³ - Û´ - Ûµ - Û¶ - Û· - Û¸ - Û¹)
4. å…¶ä»–æœ‰ä¸€äº›è¯­è¨€ä¹Ÿæœ‰è‡ªå·±çš„æ•°å­—.

#### ä¸­æ€§å­—ç¬¦

ä¸­æ€§å­—ç¬¦çš„æ–¹å‘æ€§æ˜¯ä¸ç¡®å®šçš„ï¼Œç”±ä¸Šä¸‹æ–‡çš„ bidi å±æ€§æ¥å†³å®šå…¶æ–¹å‘ï¼Œå¦‚ `android:textDirection`

1. `æ®µè½åˆ†éš”ç¬¦`ã€`åˆ¶è¡¨ç¬¦` å’Œå¤§å¤šæ•°å…¶ä»– `ç©ºæ ¼å­—ç¬¦`
2. æ¯”å¦‚å¤§éƒ¨åˆ†çš„æ ‡ç‚¹ç¬¦å·ï¼Œ`%`ï¼Œ`@`ï¼Œ`.`ï¼Œ`+`ï¼Œ`-`ï¼Œ`[]`ï¼Œ`()`ã€`ç©ºæ ¼` ç­‰ã€‚
3. `$` æ˜¯å¼ºæ–¹å‘å­—ç¬¦ï¼Œå·¦åˆ°å³

æ¡ˆä¾‹æ˜¾ç¤ºï¼š

```
<string name="plus_user_ar">+ ÙŠÙˆÙ…</string>
```

åœ¨ as ä¸­æ˜¾ç¤ºï¼š![4yqsn](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/4yqsn.png) æ‰‹æœºæ˜¾ç¤ºæ•ˆæœï¼š

1. `android:textDirection="ltr"` <br> ![8lxnx](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/8lxnx.png)
2. `android:layoutDirection="locale"` <br> ![8z1gw](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/8z1gw.png)

### ç‰¹æ®Šå­—ç¬¦çš„ç±»å‹

### Unicode æ§åˆ¶å­—ç¬¦æ–¹å‘ (Unicode bidi support)

å¤§éƒ¨åˆ†æƒ…å†µï¼ŒUnicode åŒå‘ç®—æ³•èƒ½æ ¹æ®å­—ç¬¦å±æ€§å’Œå…¨å±€æ–¹å‘ç­‰ä¿¡æ¯è¿ç®—å¹¶æ­£ç¡®åœ°æ˜¾ç¤ºåŒå‘æ–‡å­—ï¼Œè¿™æ˜¯è¯¥ç®—æ³•çš„éšæ€§æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒåŒå‘æ–‡å­—çš„æ˜¾ç¤ºæ–¹å¼åŸºæœ¬ä¸Šç”±ç®—æ³•å®Œæˆï¼Œä¸éœ€è¦äººä¸ºçš„å¹²é¢„ã€‚ä½†æ˜¯ï¼Œéšæ€§æ¨¡å¼çš„ç®—æ³•åœ¨å¤„ç†å¤æ‚æƒ…å†µçš„åŒå‘æ–‡å­—æ—¶ä¼šæ˜¾å¾—ä¸è¶³ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨æ˜¾æ€§æ¨¡å¼æ¥è¿›è¡Œè¡¥å……ã€‚åœ¨æ˜¾æ€§æ¨¡å¼çš„ç®—æ³•ä¸­ï¼Œé™¤äº†éšæ€§ç®—æ³•çš„è¿ç®—å¤–ï¼Œå¯ä»¥åœ¨åŒå‘æ–‡å­—ä¸­åŠ å…¥å…³äºæ–¹å‘çš„ Unicode æ§åˆ¶å­—ç¬¦æ¥æ§åˆ¶æ–‡å­—çš„æ˜¾ç¤ºã€‚**è¿™äº›è¢«åŠ å…¥æ–‡å­—ä¸­çš„ Unicode æ§åˆ¶å­—ç¬¦åœ¨æ˜¾ç¤ºç•Œé¢ä¸Šæ˜¯ä¸å¯è§çš„ï¼Œä¹Ÿä¸å ç”¨ä»»ä½•æ˜¾ç¤ºç©ºé—´ã€‚å®ƒä»¬åªæ˜¯åœ¨é»˜é»˜åœ°å½±å“ç€åŒå‘æ–‡å­—çš„æ˜¾ç¤ºã€‚**

#### éšæ€§åŒå‘æ§åˆ¶å­—ç¬¦

```
U+200E:   LEFT-TO-RIGHT MARK (LRM)
U+200F:   RIGHT-TO-LEFT MARK (RLM)
```

æ‚¨å¯ä»¥å°†è¿™ç±»çš„æ§åˆ¶å­—ç¬¦çœ‹æˆæ˜¯ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥çš„å¼ºå­—ç¬¦ï¼Œ`LRM` ä¸ºä»å·¦åˆ°å³çš„å¼ºå­—ç¬¦ï¼Œè€Œ `RLM` ä¸ºä»å³åˆ°å·¦çš„å¼ºå­—ç¬¦ã€‚<br />ä»£ç ç”¨: `\u200E`

#### æ˜¾æ€§åŒå‘æ§åˆ¶å­—ç¬¦

> è¿™ç±»æ§åˆ¶å­—ç¬¦éœ€è¦æˆå¯¹ä½¿ç”¨ï¼Œåˆ—è¡¨ä¸­çš„å‰å››ä¸ªä¸ºå¼€å§‹å­—ç¬¦ï¼Œè€Œæœ€åä¸€ä¸ªä¸ºç»“æŸå­—ç¬¦ã€‚

```
U+202A:   LEFT-TO-RIGHT EMBEDDING (LRE)
U+202B:   RIGHT-TO-LEFT EMBEDDING (RLE)
U+202D:   LEFT-TO-RIGHT OVERRIDE (LRO)
U+202E:   RIGHT-TO-LEFT OVERRIDE (RLO)
U+202C:   POP DIRECTIONAL FORMATTING (PDF)
```

- LRE<br />å½“åŒå‘ç®—æ³•é‡åˆ° LRE æ—¶ï¼Œæ¥ä¸‹æ¥æ–‡å­—ç‰‡æ®µå†…çš„æ–¹å‘å¼€å§‹å˜ä¸ºä»å·¦åˆ°å³
- RLE<br />å½“åŒå‘ç®—æ³•é‡åˆ° RLE æ—¶ï¼Œæ¥ä¸‹æ¥æ–‡å­—ç‰‡æ®µå†…çš„æ–¹å‘å¼€å§‹å˜ä¸ºä»å³åˆ°å·¦
- LRO<br />å½“é‡åˆ° LRO æ—¶ï¼ŒåŒå‘ç®—æ³•ä¼šå°†åé¢æ‰€æœ‰æ–‡å­—çš„åŒå‘å±æ€§è§†ä¸ºä»å·¦åˆ°å³å¼ºå­—ç¬¦ã€‚
- RLO<br />å½“é‡åˆ° RLO æ—¶ï¼ŒåŒå‘ç®—æ³•ä¼šå°†åé¢æ‰€æœ‰æ–‡å­—çš„åŒå‘å±æ€§è§†ä¸ºä»å³åˆ°å·¦å¼ºå­—ç¬¦ã€‚
- PDF<br />å¦‚æœä¸€æ—¦é‡åˆ° PDF å­—ç¬¦ï¼ŒåŒå‘å±æ€§çš„çŠ¶æ€å°±ä¼šæ¢å¤åˆ°æœ€åä¸€ä¸ª LREã€RLEã€LRO æˆ– RLO ä¹‹å‰çš„çŠ¶æ€ã€‚

## BidiFormatter ç”¨æ³•

### TextDirectionHeuristicCompat æš‚ä¸”ç§°å‘¼ä¸ºæ–¹å‘è¯„ä¼°å™¨

ç”¨äºæ¨æ–­ä¸€æ®µæ–‡æœ¬çš„æ–¹å‘ï¼Œå†…ç½®çš„æ–¹å‘è¯„ä¼°å™¨æœ‰ï¼š

### TextDirectionHeuristicsCompat.LTR

æ–¹å‘æ€»æ˜¯ left to right

### TextDirectionHeuristicsCompat.RTL

æ–¹å‘æ€»æ˜¯ right to left

### TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR é»˜è®¤

`Unicode Bidirectional Algorithm` é»˜è®¤ï¼ŒTextView çš„ `android:textDirection/setTextDirection` é»˜è®¤ï¼›å–ç¬¬ä¸€ä¸ªå¼ºå­—ç¬¦ (åŒ…æ‹¬ bidi æ§åˆ¶å­—ç¬¦) çš„æ–¹å‘ä½œä¸ºæ–‡æœ¬æ–¹å‘ï¼Œå¦‚æœæ²¡æœ‰å¼ºå­—ç¬¦ï¼Œè¯¥æ®µè½çš„æ–‡æœ¬æ–¹å‘æ˜¯ LTR

### TextDirectionHeuristicsCompat.FIRSTSTRONG_RTL

å–ç¬¬ä¸€ä¸ªå¼ºå­—ç¬¦ (åŒ…æ‹¬ bidi æ§åˆ¶å­—ç¬¦) çš„æ–¹å‘ä½œä¸ºæ–‡æœ¬æ–¹å‘ï¼Œå¦‚æœæ²¡æœ‰å¼ºå­—ç¬¦ï¼Œè¯¥æ®µè½çš„æ–‡æœ¬æ–¹å‘æ˜¯ RTL

### TextDirectionHeuristicsCompat.ANYRTL_LTR

å­˜åœ¨ä»»ä½• right to left çš„ non-format å­—ç¬¦ç¡®å®šæ–¹å‘ä¸º right to leftï¼›å¦åˆ™ä¸º left to right

### TextDirectionHeuristicsCompat.LOCALE

å¼ºåˆ¶æ–¹å‘ä¸º localeï¼›Falls back to left to right.

## BidiFormatter ä½œç”¨

### 1. Directionality estimation

BidiFormatter é»˜è®¤æ–¹å‘è¯„ä¼°å™¨æ˜¯çš„ `TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR`

- public boolean isRtl(String str)<br />ç»™å®šçš„æ–‡æœ¬æ–¹å‘æ˜¯å¦æ˜¯ RTLï¼›ç”¨ç»™å®šçš„ `mDefaultTextDirectionHeuristicCompat` æ¥æ¨æ–­ str çš„æ–¹å‘ï¼Œé»˜è®¤æ–¹å‘è¯„ä¼°å™¨ä¸º `FIRSTSTRONG_LTR`

### 2. Bidi Wrapping

- public CharSequence unicodeWrap(CharSequence str, TextDirectionHeuristicCompat heuristic, boolean isolate)
  - å‚æ•° 1 str è¦åŒ…è£¹çš„æ–‡æœ¬
  - å‚æ•° 2 heuristic æ–‡æœ¬æ–¹å‘è¯„ä¼°å™¨ï¼Œç”¨æ¥è¯„ä¼°æ•´æ®µ str çš„æ–¹å‘
  - å‚æ•° 3 isolate æ˜¯å¦éš”ç¦»ï¼Œé˜²æ­¢å…¶å½±å“å‰åå­—ç¬¦æ–¹å‘

### BidiFormatter å®ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1ï¼šå……å€¼ä¼˜æƒ æ–‡æ¡ˆ

## BidiFormatter è¯¦è§£

### BidiFormatter å®ä¾‹åŒ–

ä» BidiFormatter å®ä¾‹åŒ–å…¥å£å¼€å§‹çœ‹ï¼š

```java
public static BidiFormatter getInstance() {
    return new Builder().build();
}
```

BidiFormatter å®ä¾‹åŒ–ç”¨äº† Builder æ¨¡å¼ï¼Œå†çœ‹ Builder() é»˜è®¤å€¼

```java
å½“å‰Localeæ–¹å‘æ˜¯å¦æ˜¯RTL
static boolean isRtlLocale(Locale locale) {
    return (TextUtilsCompat.getLayoutDirectionFromLocale(locale) == ViewCompat.LAYOUT_DIRECTION_RTL);
}

public static final class Builder {
    private boolean mIsRtlContext;
    private int mFlags;
    private TextDirectionHeuristicCompat mTextDirectionHeuristicCompat;

    public Builder() {
        initialize(isRtlLocale(Locale.getDefault()));
    }
    
    private void initialize(boolean isRtlContext) {
        mIsRtlContext = isRtlContext;
        mTextDirectionHeuristicCompat = DEFAULT_TEXT_DIRECTION_HEURISTIC;
        mFlags = DEFAULT_FLAGS;
    }
    public BidiFormatter build() {
        if (mFlags == DEFAULT_FLAGS &&
                mTextDirectionHeuristicCompat == DEFAULT_TEXT_DIRECTION_HEURISTIC) {
            return getDefaultInstanceFromContext(mIsRtlContext);
        }
        return new BidiFormatter(mIsRtlContext, mFlags, mTextDirectionHeuristicCompat);
    }
}
```

å°ç»“ï¼š

1. BidiFormatter é»˜è®¤çš„å…¨å±€æ–¹å‘ mIsRtlContext æ˜¯æ ¹æ®å½“å‰ Locale æ‰å†³å®šçš„ï¼Œé˜¿è¯­ç¯å¢ƒæ˜¯ RTLï¼Œä¸­/è‹±è¯­ç¯å¢ƒæ˜¯ LTR
2. mTextDirectionHeuristicCompat æ–¹å‘æ¨ç†å™¨é»˜è®¤ä¸º `DEFAULT_TEXT_DIRECTION_HEURISTIC`

`DEFAULT_TEXT_DIRECTION_HEURISTIC` æ˜¯ä»€ä¹ˆï¼Ÿ

```java
// é»˜è®¤æ–¹å‘æ¨ç†å™¨
static final TextDirectionHeuristicCompat DEFAULT_TEXT_DIRECTION_HEURISTIC = FIRSTSTRONG_LTR;

// æ ¹æ®ç¬¬ä¸€ä¸ªå¼ºå­—ç¬¦æ¥ç¡®å®šæ–¹å‘ï¼ŒåŒ…æ‹¬bidiæ§åˆ¶å­—ç¬¦ï¼›å¦‚æœæ‰¾ä¸åˆ°é»˜è®¤ä¸ºLTRæ–¹å‘ï¼›è¿™ä¸ªæ˜¯åŒå‘å­—ç¬¦ç®—æ³•é»˜è®¤è¡Œä¸º
public static final androidx.core.text.TextDirectionHeuristicCompat FIRSTSTRONG_LTR =
            new TextDirectionHeuristicInternal(FirstStrong.INSTANCE, false);
```

### unicodeWrap

unicodeWrap å¾ˆå¤šé‡è½½çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¸¸ç”¨çš„

```java
public String unicodeWrap(String str) {
    return unicodeWrap(str, mDefaultTextDirectionHeuristicCompat, true /* isolate */);
}
```

æœ€ç»ˆéƒ½æ˜¯èµ°åˆ°è¿™é‡Œï¼š

```java
public CharSequence unicodeWrap(CharSequence str, TextDirectionHeuristicCompat heuristic, boolean isolate) {
    if (str == null) return null;
    final boolean isRtl = heuristic.isRtl(str, 0, str.length()); // å½“å‰æ–‡æœ¬æ˜¯å¦RTLæ ¹æ®heuristic
    SpannableStringBuilder result = new SpannableStringBuilder();
    if (getStereoReset() && isolate) { // éœ€è¦éš”ç¦»ï¼Œ
        // æ·»åŠ éš”ç¦»ç¬¦
        result.append(markBefore(str,
                isRtl ? TextDirectionHeuristicsCompat.RTL : TextDirectionHeuristicsCompat.LTR));
    }
    if (isRtl != mIsRtlContext) {
        // å¦‚æœæ–‡æœ¬æ–¹å‘å’Œä¸Šä¸‹æ–‡æ–¹å‘ä¸ä¸€è‡´ï¼Œæ ¹æ®æ–‡æœ¬æ–¹å‘æ·»åŠ å¯¹åº”çš„RLEå’ŒLRE
        result.append(isRtl ? RLE : LRE);
        result.append(str);
        result.append(PDF);
    } else {
        result.append(str);
    }
    if (isolate) {
        result.append(markAfter(str,
                isRtl ? TextDirectionHeuristicsCompat.RTL : TextDirectionHeuristicsCompat.LTR));
    }
    return result;
}

// åœ¨æ–‡æœ¬å‰é¢æ·»åŠ ï¼›å¯¹äºRTLæ–‡æœ¬æ·»åŠ LRMåœ¨LTRä¸Šä¸‹æ–‡ï¼›å¯¹äºLTRæ–‡æœ¬æ·»åŠ RLMåœ¨RTLä¸Šä¸‹æ–‡ï¼›å…¶ä»–æƒ…å†µæ·»åŠ ç©ºä¸²
private String markBefore(CharSequence str, TextDirectionHeuristicCompat heuristic) {
    final boolean isRtl = heuristic.isRtl(str, 0, str.length());
    // getEntryDir() is called only if needed (short-circuit).
    if (!mIsRtlContext && (isRtl || getEntryDir(str) == DIR_RTL)) {
        return LRM_STRING;
    }
    if (mIsRtlContext && (!isRtl || getEntryDir(str) == DIR_LTR)) {
        return RLM_STRING;
    }
    return EMPTY_STRING;
}

// å…·ä½“é€»è¾‘åŒmarkBeforeï¼Œåªæ˜¯åœ¨æ–‡æœ¬ç»“å°¾å¤„æ·»åŠ 
private String markAfter(CharSequence str, TextDirectionHeuristicCompat heuristic) {
    final boolean isRtl = heuristic.isRtl(str, 0, str.length());
    // getExitDir() is called only if needed (short-circuit).
    if (!mIsRtlContext && (isRtl || getExitDir(str) == DIR_RTL)) {
        return LRM_STRING;
    }
    if (mIsRtlContext && (!isRtl || getExitDir(str) == DIR_LTR)) {
        return RLM_STRING;
    }
    return EMPTY_STRING;
}
```

## Ref

- bidi ç®—æ³•åŠ HTML ä¸­çš„å®ç°<br /><https://www.ibm.com/developerworks/cn/web/1404_xiayin_bidihtml/index.html>

# å¤šè¯­è¨€é€‚é…é—®é¢˜

## HTTP header é ASCII ç ä¸èƒ½ä½œä¸º header name/valueï¼ŒOKHttp æœ‰æ£€æµ‹

åŸå› 

```
java.lang.IllegalArgumentException: Unexpected char 0x660 at 15 in Tz value: Asia/Shanghai,+Ù Ù¨:Ù Ù 
```

![eipmu](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/eipmu.png)<br />

HTTP header é ASCII ç ä¸èƒ½ä½œä¸º `header name/value`ï¼ŒOKHttp æœ‰æ£€æµ‹

```java
# Headers
static void checkName(String name) {
if (name == null) throw new NullPointerException("name == null");
if (name.isEmpty()) throw new IllegalArgumentException("name is empty");
for (int i = 0, length = name.length(); i < length; i++) {
  char c = name.charAt(i);
  if (c <= '\u0020' || c >= '\u007f') {
    throw new IllegalArgumentException(Util.format(
        "Unexpected char %#04x at %d in header name: %s", (int) c, i, name));
  }
}
}

static void checkValue(String value, String name) {
if (value == null) throw new NullPointerException("value for name " + name + " == null");
for (int i = 0, length = value.length(); i < length; i++) {
  char c = value.charAt(i);
  if ((c <= '\u001f' && c != '\t') || c >= '\u007f') {
    throw new IllegalArgumentException(Util.format(
        "Unexpected char %#04x at %d in %s value: %s", (int) c, i, name, value));
  }
}
}
```

è§£å†³ 1ï¼š<br />ç”¨ Locale.ENGLISH æ¥æ ¼å¼åŒ–

```kotlin
@JvmStatic
fun getCurrentTimezone(): String {
    val tz = TimeZone.getDefault()
    val cal = GregorianCalendar.getInstance(tz)
    val offsetInMillis = tz.getOffset(cal.timeInMillis)

    var offset = String.format(Locale.ENGLISH, "%02d:%02d",
            abs(offsetInMillis / 3600000),
            abs(offsetInMillis / 60000 % 60))
    offset = (if (offsetInMillis >= 0) "+" else "-") + offset
    return "${TimeZone.getDefault().id},${offset}"
}
```

è§£å†³ 2ï¼š<br />è¿›è¡Œ URLEncode

## é˜¿è¯­ä¸‹è¯­éŸ³èŠå¤©å®¤é€šè¿‡ WebSocket å‘é€æŸäº›ç‰¹æ®Šå­—ç¬¦å´©æºƒ

ç‰¹æ®Šå­—ç¬¦ï¼š

```
_ãƒ½ ã€€ ï¼¼ï¼¼ Î›ï¼¿Î› ã€€ã€€ ï¼¼( 'ã……' ) ã€€ã€€ã€€ >ã€€âŒ’ãƒ½ ã€€ã€€ã€€/ ã€€ ã¸ï¼¼ ã€€ã€€ /ã€€ã€€/ã€€ï¼¼ï¼¼ ã€€ã€€ ï¾šã€€ãƒã€€ã€€ ãƒ½_ã¤ ã€€ã€€/ã€€/ ã€€ /ã€€/| ã€€(ã€€(ãƒ½ ã€€_ãƒ½ ã€€ ï¼¼ï¼¼ Î›ï¼¿Î› ã€€ã€€ ï¼¼( 'ã……' ) ã€€ã€€ã€€ >ã€€âŒ’ãƒ½ ã€€ã€€ã€€/ ã€€ ã¸ï¼¼ ã€€ã€€ /ã€€ã€€/ã€€ï¼¼ï¼¼ ã€€ã€€ ï¾šã€€ãƒã€€ã€€ ãƒ½_ã¤ ã€€ã€€/ã€€/ ã€€ /ã€€/| ã€€(ã€€(ãƒ½ ã€€âŠ‚_ãƒ½ ã€€ ï¼¼ï¼¼ Î›ï¼¿Î› ã€€ã€€ ï¼¼( 'ã……' )
```

å´©æºƒæ—¥å¿—ï¼š

```
Fatal Exception: java.lang.IndexOutOfBoundsException: measureLimit (32) is out of start (36) and limit (32) bounds
       at android.text.TextLine.handleRun + 1113(TextLine.java:1113)
       at android.text.TextLine.drawRun + 509(TextLine.java:509)
       at android.text.TextLine.draw + 280(TextLine.java:280)
       at android.text.Layout.drawText + 581(Layout.java:581)
       at android.text.Layout.draw + 333(Layout.java:333)
       at android.widget.TextView.onDraw + 8108(TextView.java:8108)
       at android.view.View.draw + 21870(View.java:21870)
       at android.view.View.updateDisplayListIfDirty + 20743(View.java:20743)
       at android.view.View.draw + 21596(View.java:21596)
       at android.view.ViewGroup.drawChild + 4558(ViewGroup.java:4558)
       at android.view.ViewGroup.dispatchDraw + 4333(ViewGroup.java:4333)
       at android.view.View.draw + 21873(View.java:21873)
       at android.view.View.updateDisplayListIfDirty + 20743(View.java:20743)
       at android.view.View.draw + 21596(View.java:21596)
       at android.view.ViewGroup.drawChild + 4558(ViewGroup.java:4558)
       at android.view.ViewGroup.dispatchDraw + 4333(ViewGroup.java:4333)
       at android.view.View.updateDisplayListIfDirty + 20729(View.java:20729)
       at android.view.View.draw + 21596(View.java:21596)
       at android.view.ViewGroup.drawChild + 4558(ViewGroup.java:4558)
       at android.support.v7.widget.RecyclerView.drawChild + 4703(RecyclerView.java:4703)
       at android.view.ViewGroup.dispatchDraw + 4333(ViewGroup.java:4333)
       at android.view.View.draw + 21873(View.java:21873)
       at android.support.v7.widget.RecyclerView.draw + 4107(RecyclerView.java:4107)
       at android.view.View.updateDisplayListIfDirty + 20743(View.java:20743)
       at android.view.View.draw + 21596(View.java:21596)
       at android.view.ViewGroup.drawChild + 4558(ViewGroup.java:4558)
       at android.view.ViewGroup.dispatchDraw + 4333(ViewGroup.java:4333)
       at android.view.View.updateDisplayListIfDirty + 20729(View.java:20729)
       at android.view.View.draw + 21596(View.java:21596)
       at android.view.ViewGroup.drawChild + 4558(ViewGroup.java:4558)
       at android.view.ViewGroup.dispatchDraw + 4333(ViewGroup.java:4333)
       at android.view.View.updateDisplayListIfDirty + 20729(View.java:20729)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ViewGroup.recreateChildDisplayList + 4542(ViewGroup.java:4542)
       at android.view.ViewGroup.dispatchGetDisplayList + 4514(ViewGroup.java:4514)
       at android.view.View.updateDisplayListIfDirty + 20698(View.java:20698)
       at android.view.ThreadedRenderer.updateViewTreeDisplayList + 725(ThreadedRenderer.java:725)
       at android.view.ThreadedRenderer.updateRootDisplayList + 731(ThreadedRenderer.java:731)
       at android.view.ThreadedRenderer.draw + 840(ThreadedRenderer.java:840)
       at android.view.ViewRootImpl.draw + 3981(ViewRootImpl.java:3981)
       at android.view.ViewRootImpl.performDraw + 3755(ViewRootImpl.java:3755)
       at android.view.ViewRootImpl.performTraversals + 3064(ViewRootImpl.java:3064)
       at android.view.ViewRootImpl.doTraversal + 1927(ViewRootImpl.java:1927)
       at android.view.ViewRootImpl$TraversalRunnable.run + 8558(ViewRootImpl.java:8558)
       at android.view.Choreographer$CallbackRecord.run + 949(Choreographer.java:949)
       at android.view.Choreographer.doCallbacks + 761(Choreographer.java:761)
       at android.view.Choreographer.doFrame + 696(Choreographer.java:696)
       at android.view.Choreographer$FrameDisplayEventReceiver.run + 935(Choreographer.java:935)
       at android.os.Handler.handleCallback + 873(Handler.java:873)
       at android.os.Handler.dispatchMessage + 99(Handler.java:99)
       at android.os.Looper.loop + 214(Looper.java:214)
       at android.app.ActivityThread.main + 7094(ActivityThread.java:7094)
       at java.lang.reflect.Method.invoke(Method.java)
       at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run + 494(RuntimeInit.java:494)
       at com.android.internal.os.ZygoteInit.main + 975(ZygoteInit.java:975)
```

<https://console.firebase.google.com/project/qsbk-voicechat-001/crashlytics/app/android>: club.jinmei.mgvoice/issues/619ae6add3d2aa8dadbc96edde8ef832?time=last-seven-days>

<br /><https://console.firebase.google.com/project/qsbk-voicechat-001/crashlytics/app/android>: club.jinmei.mgvoice/issues/2a55b0caccda193220618099fcb1b55c?time=last-seven-days&sessionId=5DF01588005700012EF1313C42B30DC3_DNE_0_v2><br />

åŸå› :

> åœ¨é˜¿è¯­ç¯å¢ƒä¸‹ï¼Œè¿™äº›å­—ç¬¦ä¼šå¼•èµ·å´©æºƒï¼›éé˜¿è¯­ä¸ä¼šå´©æºƒ

```
èŠå¤©æ¶ˆæ¯å’Œæ˜µç§°ä»¥åŠå…¶ä»–ä¸€äº›å¾½ç« å›¾ç‰‡ç­‰éƒ½æ˜¯åœ¨åŒä¸€ä¸ªtextviewé‡Œé¢ï¼Œé€šè¿‡spannableæ¥è¿›è¡Œæ’ç‰ˆçš„ã€‚é˜¿æ‹‰ä¼¯å­—æ¯çš„å‡ºç°æ‰“ä¹±äº†spannableé¡ºåºï¼Œå¼•èµ·äº†è¿™æ¬¡äº‹æ•…
```

è§£å†³ 1ï¼š<br />TextView å’Œ EditText éœ€è¦åŠ ä¸Šï¼Œä¼¼ä¹æ²¡æœ‰ç”¨

```xml
android:textDirection="ltr"
android:textAlignment="viewStart"
```

è§£å†³ 2ï¼šå…ˆ try catchï¼Œæœ‰é—®é¢˜æ¢æ‰ä¸€äº›ç©ºæ ¼ï¼Œå†è°ƒç”¨ã€‚

> Mashi è¿™æ ·å¤„ç†çš„ï¼Œå…·ä½“çœ‹çº¿ä¸Šæƒ…å†µ

```java
public class BaseCoreTextView extends AppCompatTextView {

    private boolean mAutoRetryWhenIndexOutOfBoundsException = true;

    public BaseCoreTextView(Context context) {
        super(context);
    }

    public BaseCoreTextView(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    public BaseCoreTextView(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);
    }

    /**
     * å­—ç¬¦ä¸²è½¬æ¢unicode
     */
    public final static String string2Unicode(CharSequence string) {
        StringBuffer unicode = new StringBuffer();
        for (int i = 0; i < string.length(); i++) {
            // å–å‡ºæ¯ä¸€ä¸ªå­—ç¬¦
            char c = string.charAt(i);
            // è½¬æ¢ä¸ºunicode
            unicode.append("\\u" + Integer.toHexString(c));
        }
        return unicode.toString();
    }

    /**
     * å½“onDraw å‡ºç°IndexOutOfBoundsExceptionçš„æ—¶å€™ï¼Œæ˜¯å¦è‡ªåŠ¨é‡è¯•
     */
    public boolean isAutoRetryWhenIndexOutOfBoundsException() {
        return mAutoRetryWhenIndexOutOfBoundsException;
    }

    /**
     * å½“onDraw å‡ºç°IndexOutOfBoundsExceptionçš„æ—¶å€™ï¼Œæ˜¯å¦è‡ªåŠ¨é‡è¯•
     */
    public void setAutoRetryWhenIndexOutOfBoundsException(boolean autoRetry) {
        this.mAutoRetryWhenIndexOutOfBoundsException = autoRetry;
    }

    @Override
    protected void onDraw(Canvas canvas) {
        try {
            super.onDraw(canvas);
        } catch (IndexOutOfBoundsException e) {
            if (mAutoRetryWhenIndexOutOfBoundsException) {
                CharSequence text = getText();
                text = StringCodeUtils.replaceWiredSpace2NormalSpace(text);
                setText(text);
            }
            boolean isRetry = (mAutoRetryWhenIndexOutOfBoundsException);
            logIndexOutOfBoundsException(e, isRetry);
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å´©æºƒ
            // throw e;
        } catch (Throwable e) {
        }
    }

    private void logIndexOutOfBoundsException(IndexOutOfBoundsException e, boolean isRetry) {
        final int id = getId();
        final CharSequence text = getText();
        final Map<String, String> map = new HashMap<>();
        map.put("id", String.valueOf(id));
        map.put("text", string2Unicode(text));
        map.put("exception", e.getMessage());
        map.put("retry", (isRetry ? "1" : "0"));
        Statistic.getInstance().onEvent(getContext(), "TextView", map);
    }
}

public final class StringCodeUtils {
    public static final CharSequence NORMAL_SPACE = " ";
    /**
     * æŠŠä¸€äº›æ¶å¿ƒçš„spaceæ›¿æ¢æˆæ­£å¸¸çš„space
     */
    public static CharSequence replaceWiredSpace2NormalSpace(CharSequence charSequence) {
        if (!TextUtils.isEmpty(charSequence)) {
            final int length = charSequence.length();
            StringBuilder stringBuilder = new StringBuilder(length);
            char ch;
            for (int i = 0; i < length; i++) {
                ch = charSequence.charAt(i);
                if (Character.isSpaceChar(ch) || Character.isWhitespace(ch)) {
                    stringBuilder.append(NORMAL_SPACE);
                } else {
                    stringBuilder.append(ch);
                }
            }
            return stringBuilder.toString();
        }
        return charSequence;
    }
}
```

## Ref

- é˜¿æ‹‰ä¼¯å­—æ¯ä¸ LTR ä¹¦å†™è¯­ç³»æ··æ’å¥”æºƒé—®é¢˜<br />[https://www.androidcycle.com/é˜¿æ‹‰ä¼¯å­—æ¯ä¸lträ¹¦å†™è¯­ç³»æ··æ’å¥”æºƒé—®é¢˜-ltr-rtl-with-spannable-in-the-same/](https://www.androidcycle.com/%E9%98%BF%E6%8B%89%E4%BC%AF%E5%AD%97%E6%AF%8D%E4%B8%8Eltr%E4%B9%A6%E5%86%99%E8%AF%AD%E7%B3%BB%E6%B7%B7%E6%8E%92%E5%A5%94%E6%BA%83%E9%97%AE%E9%A2%98-ltr-rtl-with-spannable-in-the-same/)

# é˜¿è¯­è‹±æ–‡æ··ç¼–

## BidiFormatter

åŒæ–¹å‘å­—ç¬¦æ‘†æ”¾ï¼Œæ’å…¥æ§åˆ¶å­—ç¬¦ï¼Œæ¥ä¿è¯æ®µè½å­—ç¬¦çš„æ­£ç¡®æ‘†æ”¾

1. æ ¹æ®ç»™å®šçš„ `TextDirectionHeuristicCompat`ï¼Œæ¨æ–­å‡ºç»™å®šæ–‡æœ¬çš„æ–¹å‘ï¼Œæ’å…¥ bidi æ§åˆ¶å­—ç¬¦
2. å½“å‰çš„æ–‡æœ¬çš„æ–¹å‘å’Œå…¨å±€æ–¹å‘ç›¸åçš„ï¼Œä¼šæ’å…¥å¯¹åº”çš„ bidi å­—ç¬¦ï¼Œè®©è¿™æ®µæ–‡æœ¬æ˜¾ç¤ºæ­£ç¡®

en ç¯å¢ƒçš„å…¨å±€æ–¹å‘ä¸º LTRï¼›ar ç¯å¢ƒå…¨å±€æ–¹å‘ä¸º RTL

```
éšæ€§åŒå‘æ§åˆ¶å­—ç¬¦:
    U+200E:   LEFT-TO-RIGHT MARK (LRM) ä»å·¦åˆ°å³çš„å¼ºå­—ç¬¦
    U+200F:   RIGHT-TO-LEFT MARK (RLM) ä»å³åˆ°å·¦çš„å¼ºå­—ç¬¦
æ˜¾æ€§åŒå‘æ§åˆ¶å­—ç¬¦:
    U+202A:   LEFT-TO-RIGHT EMBEDDING (LRE) æ¥ä¸‹æ¥æ–‡å­—ç‰‡æ®µå†…çš„æ–¹å‘å¼€å§‹å˜ä¸ºä»å·¦åˆ°å³
    U+202B:   RIGHT-TO-LEFT EMBEDDING (RLE) æ¥ä¸‹æ¥æ–‡å­—ç‰‡æ®µå†…çš„æ–¹å‘å¼€å§‹å˜ä¸ºä»å³åˆ°å·¦
    U+202D:   LEFT-TO-RIGHT OVERRIDE (LRO) åé¢æ‰€æœ‰æ–‡å­—çš„åŒå‘å±æ€§è§†ä¸ºä»å·¦åˆ°å³å¼ºå­—ç¬¦
    U+202E:   RIGHT-TO-LEFT OVERRIDE (RLO) åé¢æ‰€æœ‰æ–‡å­—çš„åŒå‘å±æ€§è§†ä¸ºä»å³åˆ°å·¦å¼ºå­—ç¬¦
    U+202C:   POP DIRECTIONAL FORMATTING (PDF) ä¸€æ—¦é‡åˆ° PDF å­—ç¬¦ï¼ŒåŒå‘å±æ€§çš„çŠ¶æ€å°±ä¼šæ¢å¤åˆ°æœ€åä¸€ä¸ª LREã€RLEã€LRO æˆ– RLO ä¹‹å‰çš„çŠ¶æ€ã€‚
```

### 1. è‹±æ–‡ + é˜¿è¯­ï¼ˆé¦–å­—ç¬¦è‹±æ–‡ï¼ŒLTRï¼‰

#### en ç¯å¢ƒ

1. é»˜è®¤è¡Œä¸ºï¼Œä»å·¦åˆ°å³æ˜¾ç¤ºï¼Œè‹±æ–‡åœ¨å‰ï¼Œé˜¿è¯­åœ¨å
2. BidiFormatter é»˜è®¤è¡Œä¸ºï¼Œæ˜¯æ ¹æ®é¦–å­—æ¯æ¥ç¡®å®šè¯¥æ®µæ–‡æœ¬æ–¹å‘ï¼Œé¦–å­—æ¯è‹±æ–‡ï¼Œé‚£è¯¥æ®µæ–‡æœ¬çš„æ–¹å‘ä¸ºä»å·¦åˆ°å³ï¼Œæ˜¾ç¤ºåŒ `1.é»˜è®¤è¡Œä¸º`
3. BidiFormatter ANYRTL_LTR è¡Œä¸ºï¼Œæœ‰ä»»ä½• RTL å­—ç¬¦å°±ç¡®å®šä¸º RLT æ–¹å‘ï¼Œæ‰€ä»¥è¯¥æ®µæ–‡æœ¬ä»å³åˆ°å·¦æ˜¾ç¤º

#### ar ç¯å¢ƒ

![kqwe4](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/kqwe4.png)

### 2. é˜¿è¯­ + è‹±æ–‡ï¼ˆé¦–å­—ç¬¦è‹±æ–‡ï¼ŒRTLï¼‰

#### en

![sqsw4](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/sqsw4.png)

#### ar

![wfcf3](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/wfcf3.png)

### 3. @+ è‹±æ–‡ + é˜¿è¯­ (é¦–å­—ç¬¦å¼±å­—ç¬¦)

#### en

![rpv2j](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/rpv2j.png)

#### ar

![me33o](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/me33o.png)

### 4. @+ é˜¿è¯­ + è‹±æ–‡ (é¦–å­—ç¬¦å¼±å­—ç¬¦)

#### en

![8vz0s](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/8vz0s.png)

#### ar

![uo5tm](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/uo5tm.png)

### 5. æ•°å­— + è‹±æ–‡ + é˜¿è¯­ï¼ˆé¦–å­—ç¬¦ä¸­æ€§å­—ç¬¦ï¼‰

#### en

![7knqi](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/7knqi.png)

#### ar

![y7bou](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/y7bou.png)

### 6. æ•°å­— + é˜¿è¯­ + è‹±æ–‡ï¼ˆé¦–å­—ç¬¦ä¸­æ€§å­—ç¬¦ï¼‰

#### en

![dzbp3](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/dzbp3.png)

#### ar ç¯å¢ƒ

![p5tl4](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/p5tl4.png)

### 7. é˜¿è¯­ + ç™¾åˆ†æ¯”å¸¦å°æ•°ç‚¹ï¼ˆé¦–å­—ç¬¦ï¼Œé˜¿è¯­ï¼‰

#### en

![4r2j4](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/4r2j4.png)

#### ar

![37r7v](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/37r7v.png)

> è¿™é‡Œæ˜¾ç¤ºä¸æ­£ç¡®ï¼Œen å’Œ ar% éƒ½æ²¡æœ‰è·Ÿåœ¨æ•°å­—åé¢

## åŒæ–¹å‘å­—ç¬¦æ¡ˆä¾‹

### è´­ç‰©è½¦æ–‡æ¡ˆæ˜¾ç¤ºï¼ˆ- å¼€å¤´æ˜¾ç¤ºé”™è¯¯ï¼‰

![ze60n](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/ze60n.png)<br />

RTL ä¸‹ï¼Œ`-` å·è·‘åˆ°äº†å³è¾¹ï¼ŒæœŸæœ›åœ¨å·¦è¾¹

```xml
<TextView
    style="@style/LabelText"
    android:layout_marginTop="10dp"
    android:text="æ´—éŸ³è´­ç‰©è½¦æ–‡æ¡ˆ" />
<TextView
    style="@style/LabelTextSmall"
    android:text="é»˜è®¤" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="lrt" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text2"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:textDirection="ltr"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="firstStrongLtr" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text3"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:textDirection="firstStrongLtr"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="U+200E(å·¦â†’å³)" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text4"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:textDirection="firstStrongLtr"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="U+200F(å³â†’å·¦)" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text5"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="BidiFormatter(TextDirectionHeuristicsCompat.LTR)" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text6"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:background="@color/red_A100" />
<TextView
    style="@style/LabelTextSmall"
    android:text="BidiFormatter(TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR)" />
<androidx.appcompat.widget.AppCompatTextView
    android:id="@+id/tv_cart_text7"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:background="@color/red_A100" />

tv_cart_text.text = "-\$7.47"
tv_cart_text2.text = "-\$7.47"
tv_cart_text3.text = "-\$7.47"
tv_cart_text4.text = "\u200E-\$7.47"
tv_cart_text5.text = "\u200F-\$7.47"

val bidi = BidiFormatter.Builder()
    .setTextDirectionHeuristic(TextDirectionHeuristicsCompat.LTR)
    .build()
tv_cart_text6.text = bidi.unicodeWrap("-\$7.47")
val bidi2 = BidiFormatter.Builder()
    .setTextDirectionHeuristic(TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR)
    .build()
tv_cart_text7.text = bidi2.unicodeWrap("-\$7.47")
```

![bh9a7](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/bh9a7.png)

### 7 å¤© + æ˜¾ç¤º

![v80be](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/v80be.png)!

> ç¬¬äºŒä¸ªå’Œç¬¬å››ä¸ªæ•ˆæœæ˜¾ç¤ºæ­£ç¡®

```xml
<string name="one_day">â€«%dÙŠÙˆÙ…</string>
<string name="more_days">â€«%dÙŠÙˆÙ…</string>
<string name="last_days">â€«%dÙŠÙˆÙ…+â€«</string>
```

åœ¨å‰é¢åŠ ä¸Š `\u202B` ç‰¹æ®Šå­—ç¬¦

### @ç”¨æˆ·åå’Œå†…å®¹ï¼Œä¸­è‹±/é˜¿è¯­æ··ç¼–é—®é¢˜åŒ WhatsApp ä¸€æ ·å¤„ç†

è‹±è¯­æŒ‡éé˜¿è¯­ï¼Œå«è‹±è¯­ã€ä¸­æ–‡ç­‰æ‰€æœ‰ä»å·¦å¾€å³çš„è¯­è¨€<br />ç³»ç»Ÿè¯­è¨€ä¸å¹²æ¶‰ç”¨æˆ·ç”¨æˆ·æ–‡æœ¬æ¡†å†…å®¹ï¼Œåªå½±å“é¡µé¢å¸ƒå±€å·¦å³æ’ç‰ˆ<br />![dd1rd](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/dd1rd.png)

#### æµ‹è¯•

```
val s1 = "@%s ä½ å¥½å•Š."
val s2 = "@%s ÙØ§Ø±Ø³ÛŒ."
// 3ç§name
val name_en = "hacket" // è‹±æ–‡
val name_ar = "Ù…Ø§Ø¬ÙƒÙˆÙˆ" // é˜¿è¯­
val name_ar_en = "â™ ï¸â©â¦â™¨ï¸â©à¼†ã‹¡âƒ¢Ù…Ø§Ø¬ÙƒÙˆÙˆğŸ¤£à¼—" // é˜¿è¯­ç¬¦å·æ··åˆ
```

---

#### TextView é»˜è®¤

![hdsnt](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/hdsnt.png)<br />

`android:textDirection="firstStrongRtl/firstStrongLtr/firstStrong"`

> firstStrongRtl/firstStrongLtr/firstStrong éƒ½æ˜¯ç”±ç¬¬ä¸€ä¸ªå¼ºå­—ç¬¦æ¥å†³å®šæ–‡æœ¬çš„æ–¹å‘ï¼Œ@ç¬¦åˆå±äºå¼±å­—ç¬¦ï¼Œä¸èƒ½å½±å“åç»­æ–‡æœ¬çš„æ–¹å‘ã€‚

##### en ç¯å¢ƒ

![v9tb9](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/v9tb9.png)

> åˆ†æï¼Œ@å±äºå¼±å­—ç¬¦ï¼Œ

##### ar ç¯å¢ƒ

![bvhr8](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/bvhr8.png)<br />`

`android:textDirection="locale"`

##### en ç¯å¢ƒ

![wsg0w](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/wsg0w.png)

##### ar ç¯å¢ƒ

![x8pbc](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian/x8pbc.png)

#### `android:textDirection="rtl"`

#### Mashi ä¸­@æ ¹æ®ç¬¬ä¸€ä¸ªå†…å®¹æ¥å¤„ç†æ–¹å‘

```kotlin
/**
 * ä¸å¯è§å­—ç¬¦
 */
const val CHAR_INVISIBLE = "\u0001"

/**
 * Unicode "Left-To-Right Embedding" (LRE) character.
 */
const val LRE = "\u202A" // LTR

/**
 * Unicode "Right-To-Left Embedding" (RLE) character.
 */
const val RLE = "\u202B" // RTL

const val LRO = "\u202D"
const val RLO = "\u202E"
const val PDF = "\u202C"

// ä¸å¯è§å­—ç¬¦â€\u200bâ€ä¸º Unicode Character â€˜ZERO WIDTH SPACEâ€™ (U+200B)ï¼Œå¯ç”¨äºå†…å®¹æ ‡è¯†ï¼Œä¸å ä½æ•°ã€‚
const val CHAR_ZERO_WIDTH_SPACE = "\u200B"

const val CHAR_AT = "@"

// RoomAtMessage
class RoomAtMessage : RoomChatBaseMessage() {

    @SerializedName("c")
    var content: RoomAtBean? = null

    companion object {
        const val TAG = "at"

        fun createAtMessage(atUser: MutableList<User>, fromUser: User, textContent: String, atColor: String = "#00FFC8"): RoomAtMessage {
            val message = RoomAtMessage()
            message.content = RoomAtMessage().RoomAtBean()
            message.content?.atColor = atColor
            message.content?.at_users = atUser
            message.content?.text = textContent
            message.user = fromUser
            message.messageType = BaseRoomMessage.ROOM_COMMON_AT_TYPE
            var localMsgId = System.nanoTime()
            if (localMsgId < 0) {
                localMsgId = -localMsgId // ä¿è¯å¾—åˆ°çš„æ˜¯æ­£æ•°
            }
            message.messageId = localMsgId
            return message
        }
    }

    override fun toString(): String {
        val namesWithUnicode = content?.at_users?.joinToString(separator = ",", transform = {
            val name = it.name ?: ""
            "$name(${name.string2Unicode()})"
        })
        return "[${namesWithUnicode}]\t\t${GsonUtils.toJson(this)}"
    }

    @Keep
    inner class RoomAtBean {
        @SerializedName("at_users")
        var at_users: List<User>? = null

        @SerializedName("at_color")
        var atColor: String? = null
        var text: String? = null

        override fun toString(): String {
            return "ã€text=$textï¼Œat_color=$atColorï¼Œat_users=$at_usersã€‘"
        }

        @ColorInt
        private fun getAtColorInt(): Int {
            try {
                if (atColor?.contains("#") != true) {
                    atColor = "#$atColor"
                }
                return Color.parseColor(atColor)
            } catch (e: Exception) {
                e.printStackTrace()

            }
            return ResUtils.getColor(R.color.white)
        }

        fun getAtUsers(): List<User> {
            return if (at_users.isNullOrEmpty()) {
                emptyList()
            } else {
                at_users!!
            }
        }

        /**
         * atæ¶ˆæ¯ï¼Œå–ç¬¬ä¸€ä¸ªå†…å®¹ä½œä¸ºå…¨å±€æ–¹å‘åˆ¤æ–­
         */
        private fun getRtlContext(): Boolean {
            val temp = text ?: return false
            val b = temp.length > CHAR_INVISIBLE.length + 1
            // å­˜åœ¨ä»»ä½•RTLå­—ç¬¦è®¤ä¸ºæ˜¯RTL
            val isRtlContext = if (b) TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR.isRtl(temp, CHAR_INVISIBLE.length + 1, 1) else false
            LogUtils.i(TAG, "${anchor("getRtlContext")}rtlContext=$isRtlContextï¼Œ[åŸå§‹][$temp]ï¼Œtemp length=${temp.length}")
            return isRtlContext
        }

        private fun getAtUserNames(): List<String> {
            return if (at_users.isNullOrEmpty()) {
                emptyList()
            } else {
                val names = LinkedList<String>()
                at_users?.forEachIndexed { index, user ->
                    names.add(user.getAtName(index, getRtlContext()))
                }
                names
            }
        }

        private fun getWrapperUnicodeName(name: String, rtlContext: Boolean, isFirstAt: Boolean = false): String {
            return if (rtlContext) {
                "${RLO}$name $PDF"
            } else {
                "$LRO$name $PDF"
            }
        }

        private fun getSpanText(): String {
            if (text.isNullOrBlank()) {
                return ""
            }
            val atUserNames = getAtUserNames()
            if (atUserNames.isNullOrEmpty()) {
                return text!!
            }

            var temp = text!!

            for (index in atUserNames.indices) {
                val atUserName = atUserNames[index]
                // è¾“å…¥æ¡†@äººå±•ç¤ºè§„åˆ™æ ¹æ®å·²è¾“å…¥çš„å­—ç¬¦å’Œç”¨æˆ·åé¦–å­—æ¯æ¥ç¡®å®š by xulinag
                // val isHasRtl = TextDirectionHeuristicsCompat.FIRSTSTRONG_LTR.isRtl(atUserName, 0, 1)
                // temp = temp.replaceFirst(CHAR_INVISIBLE, getWrapperUnicodeName(atUserName, getRtlContext() || isHasRtl, index == 0))
                temp = temp.replaceFirst(CHAR_INVISIBLE, getWrapperUnicodeName(atUserName, getRtlContext(), index == 0))
            }
            LogUtils.i(TAG, "${anchor("getSpanText")}[æ›¿æ¢å]temp=$temp")
            return temp
        }

        fun bindText(textView: TextView, bubble: StoreGoodsPreview?, clickAction: (User.() -> Unit)? = null) {
            val linkBuilder = LinkBuilder.from(GlobalContext.getAppContext(), getSpanText())
            val atUsers = at_users ?: emptyList()
            for (index in atUsers.indices) {
                val user = atUsers[index]
                linkBuilder.addLink(Link(user.getAtName(index, getRtlContext()))
                        .setOnClickListener {
                            clickAction?.invoke(user)
                            LogUtils.i(TAG, "${anchor("bindText")}onClick uid=${user.id}ï¼Œit=$it")
                        }
                        .setUnderlined(false)
//                        .setTextColorOfHighlightedLink()
                        .setTextColor(bubble?.atColor() ?: getAtColorInt()))
            }
            val cs = linkBuilder.build()
            textView.text = cs
            LogUtils.i(TAG, "${anchor("bindText")}$cs")
            textView.movementMethod = TouchableMovementMethod.instance
        }
    }
}


// User
class User {
    /**
     * \@æ¶ˆæ¯ç”¨æˆ·name æ·»åŠ ç‰¹æ®Šå­—ç¬¦å’ŒåŒå‘æ§åˆ¶å­—ç¬¦
     * @param index ç”¨äºæ·»åŠ U+200Bç‰¹æ®Šå­—ç¬¦ï¼Œè§£å†³@æ¶ˆæ¯ç›¸åŒåå­—ç‚¹å‡»è·³è½¬é—®é¢˜
     * @param isRTLContext å½“å‰ä¸€æ®µæ–‡å­—çš„å…¨å±€æ–¹å‘ï¼Œtrueæ˜¯RTLï¼Œå¦åˆ™LTR
     * @return
     */
    public String getAtName(int index, boolean isRTLContext) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < index; i++) {
            sb.append(CHAR_ZERO_WIDTH_SPACE);
        }
        sb.append(CHAR_AT);
        String unicodeWrapName = BidiFormatter.getInstance(isRTLContext).unicodeWrap(name);
        sb.append(unicodeWrapName);
        return sb.toString();
    }
}
```

## Support BiDi(åŒå‘å­—ç¬¦é›†) æ˜¾ç¤º

- Android RTL å¸ƒå±€å’ŒåŒå‘å­—ç¬¦é›†æ˜¾ç¤º<br /><https://segmentfault.com/a/1190000003781294#item-3-1>
- è‹±æ–‡ï¼Œæ³¢æ–¯æ–‡ï¼Œé˜¿æ‹‰ä¼¯æ•°å­—æ··æ’
- [https://weiwangqiang.github.io/2018/12/10/Android-rtl/#5è‹±æ–‡æ³¢æ–¯æ–‡é˜¿æ‹‰ä¼¯æ•°å­—æ··æ’](https://weiwangqiang.github.io/2018/12/10/Android-rtl/#5%E8%8B%B1%E6%96%87%E6%B3%A2%E6%96%AF%E6%96%87%E9%98%BF%E6%8B%89%E4%BC%AF%E6%95%B0%E5%AD%97%E6%B7%B7%E6%8E%92)

# å›½é™…åŒ–è¯­è¨€é€‚é…

APP å†…åªå†…ç½®éƒ¨åˆ†å¯ç”¨çš„è¯­è¨€ï¼Œå…¶ä»–çš„è¯­è¨€éƒ½æ”¾åœ¨åå°ï¼Œç”¨å¤šè¯­è¨€æ›´æ–°ç”¨ Gradle task æ¯æ¬¡åŠ¨æ€çš„ä¸‹è½½ä¸‹æ¥æ”¾åˆ° res ç›®å½•ä¸‹å»

```groovy
// ä¸‹è½½å¤šè¯­è¨€zipåŒ…ç”¨çš„æ’ä»¶
apply plugin: 'de.undercouch.download'

/**
 * ä¸‹è½½å¼€å‘ç‰ˆè¯­è¨€åŒ…
 * å¼€å‘é˜¶æ®µï¼Œè¿è¡Œè¿™ä¸ªä»»åŠ¡å¯¼å…¥å¤šè¯­è¨€
 */
task updateDevelopLanguages(group: 'language') {
    doLast {
        updateLanguageResources(3, true)
    }
}

/**
 * ä¸‹è½½ç°åº¦è¯­è¨€åŒ…
 * ç°åº¦é˜¶æ®µï¼Œç”±æµ‹è¯•ç”Ÿæˆè¯­è¨€åŒ…ä¹‹åï¼Œè¿è¡Œè¿™ä¸ªä»»åŠ¡å¯¼å…¥å¤šè¯­è¨€
 */
task updateBetaLanguages(group: 'language') {
    doLast {
        updateLanguageResources(1,true)
    }
}

/**
 * ä¸‹è½½æœ€ç»ˆç‰ˆè¯­è¨€åŒ…
 * å¤šè¯­è¨€æµ‹è¯•å®Œæˆåï¼Œæµ‹è¯•åœ¨åå°ç”Ÿæˆæœ€ç»ˆè¯­è¨€åŒ…ã€‚
 * å‘å¸ƒé˜¶æ®µï¼Œç”±æµ‹è¯•ç”Ÿæˆè¯­è¨€åŒ…ä¹‹åï¼Œè¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œæ›´æ–°å¤šè¯­è¨€
 */
task updateReleaseLanguages(group: 'language') {
    doLast {
        updateLanguageResources(2,true)
    }
}

/**
 * jenkins jobæ‰§è¡Œè¿™ä¸ª
 */
task updateJenkinsBetaLanguages(group: 'language') {
    doLast {
        updateLanguageResources(1,false)
    }
}


//https://wiki.zzz.cn/pages/viewpage.action?pageId=735548708
// 1.ä¸‹è½½å¹¶è§£å‹è¯­è¨€åŒ…
//2.æ›¿æ¢å¤šè¯­è¨€èµ„æº
//3.åˆ é™¤ä¸´æ—¶æ–‡ä»¶
//releaseType 1=ç°åº¦å‘å¸ƒ; 2=æ­£å¼å‘å¸ƒï¼›3=å¼€å‘åŒ…ï¼›
// downloadZip æ˜¯å¦ä¸‹è½½zipåŒ…ï¼Œjenkinsæ˜¯ç”¨gitlabçš„zipåŒ…
def updateLanguageResources(int releaseType, boolean downloadZip) {
    def packageInfo = downloadLanguageFileAndUnZip(releaseType, downloadZip)
    //éå†æ‰¾åˆ°é¡¹ç›®ä¸­çš„string.xmlæ–‡ä»¶
    //æ‰¾åˆ°å¯¹åº”è§£å‹å‡ºæ¥çš„å¤šè¯­è¨€æ–‡ä»¶
    //ç”¨è§£å‹åŒ…é‡Œçš„æ–‡ä»¶è¦†ç›–åŸæ–‡ä»¶
    println "å¼€å§‹æ›´æ–°æ–‡ä»¶"
    def basicPath = rootDir.parent + "/si_strings_android"
    def tempDir = new File(basicPath, "temp_data")
    def resDir = new File(basicPath + "/si_strings/src/main/res")
    def resChildDirs = resDir.listFiles()
    def valuesDirIterator = resChildDirs.iterator()
    def updatedFileNum = 0
    while (valuesDirIterator.hasNext()) {
        def valuesDir = valuesDirIterator.next()
        if (valuesDir.isDirectory()) {
            def valueDirName = valuesDir.name
            if (!valueDirName.startsWith("values")) {
                continue
            }
            def strFiles = valuesDir.listFiles()
            def valuesFileIterator = strFiles.iterator()
            File targetFile = null
            while (valuesFileIterator.hasNext()) {
                def valuesFile = valuesFileIterator.next()
                if (valuesFile.isFile() && valuesFile.name == "strings.xml") {
                    targetFile = valuesFile
                    break
                }
            }
            if (targetFile != null) {
                //æŸ¥æ‰¾è§£å‹åçš„è¯­è¨€æ˜¯å¦æœ‰è¿™ä¸ª
                def tempChildDirs = tempDir.listFiles()
                def tempFileIterator = tempChildDirs.iterator()
                File tempFile = null
                while (tempFileIterator.hasNext()) {
                    def tempChildDir = tempFileIterator.next()
                    if (tempChildDir.isDirectory()) {
                        def tempDirName = tempChildDir.name
                        if (tempDirName == valueDirName) {
                            def tempFiles = tempChildDir.listFiles()
                            def tempFilesIterator = tempFiles.iterator()
                            while (tempFilesIterator.hasNext()) {
                                def fileItem = tempFilesIterator.next()
                                if (fileItem.isFile() && fileItem.name == "strings.xml") {
                                    tempFile = fileItem
                                    break
                                }
                            }
                            break
                        }
                    }
                }
                if (tempFile != null) {
                    println ""
                    println ""
                    copy {
                        from tempFile
                        into valuesDir
                    }
                    println "ä¸´æ—¶æ–‡ä»¶è·¯å¾„:" + tempFile.path
                    println "è¦†ç›–çš„æ–‡ä»¶è·¯å¾„" + targetFile.path
                    println "---------æ›´æ–°æ–‡ä»¶å®Œæˆ" + (updatedFileNum + 1) + "-----------"
                    updatedFileNum++
                }
            }
        }
    }
    println "æ˜¯å¦åˆ é™¤äº†ä¸´æ—¶æ–‡ä»¶?" + tempDir.deleteDir()
    println "Stringæ›´æ–°å®Œæˆï¼Œæ›´æ–°äº†" + updatedFileNum + "ä¸ªæ–‡ä»¶"
    println "$packageInfo"
}

//å¤šè¯­è¨€æ–‡ä»¶ä¸‹è½½ä»»åŠ¡åŠè§£å‹ä»»åŠ¡
def downloadLanguageFileAndUnZip(int releaseType,boolean downloadZip) {
    println "downloadLanguageFileAndUnZip..."

    def basicPath = rootDir.parent + "/si_strings_android"
    def zipFileStr = ""
    def versionInfo = ""
    def dateInfo = ""
    def zipFile = ""

    if (downloadZip) {
        println "æŸ¥è¯¢è¯­è¨€åŒ…..."
        /*
        def url = 'https://b2c-admin.biz.xxx.cn/language/all_multi_lang/get_front_lang_export_pc?device_type=1&platform_type=1&device=2'
        def req = new URL(url).openConnection()
        def responseCode = req.getResponseCode()
        println "å“åº”çŠ¶æ€ï¼šStatus code=$responseCode"
        if (responseCode == 301) {
            String newUrl = req.getHeaderField("Location")
            println "301é‡å®šå‘ url=$newUrl"
            req = new URL(newUrl).openConnection()
        }
        logger.quiet "å“åº”çŠ¶æ€ï¼šStatus code=${req.getResponseCode()}"
        def result = req.getInputStream().getText()
        def resp = new groovy.json.JsonSlurper().parseText(result)
        def info = resp.info
        */
        def url = 'https://xxx.cn/lang/release/get-file-url'
        def req = new URL(url).openConnection()
        req.setRequestProperty("authorization", "xxx")
        req.setRequestProperty("Content-Type", "application/json")
        req.setDoOutput(true)
        def outputStream = req.getOutputStream()
        def writer = new OutputStreamWriter(outputStream)
        writer.write("{\"platform\": 1, \"deviceType\": 1, \"releaseType\": $releaseType}")
        writer.flush()
        println ""
        logger.quiet "å“åº”çŠ¶æ€ï¼šStatus code=${req.getResponseCode()}"
        def result = req.getInputStream().getText()
        def resp = new groovy.json.JsonSlurper().parseText(result)
        def info = resp.info
        def releaseTime = Long.parseLong("${info.releaseTime}") * 1000L
        versionInfo = "${info.version}"
        logger.quiet "è¯­è¨€åŒ…ç‰ˆæœ¬: $versionInfo"
        def packageUrl = info.fileUrl
        def date = new Date(releaseTime)
        def format = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        dateInfo = format.format(date)
        logger.quiet "è¯­è¨€åŒ…ä¸‹è½½é“¾æ¥: $packageUrl"
        logger.quiet "è¯­è¨€åŒ…å‘å¸ƒæ—¶é—´: $dateInfo"
        println ""
        println "..å¼€å§‹ä¸‹è½½è¯­è¨€åŒ…..."

        zipFile = new File(basicPath, 'language.zip')
        if (zipFile.exists()) {
            zipFile.delete()
        }
        download {
            src packageUrl
            dest zipFile
        }
        zipFileStr = zipFile.path
        println "è¯­è¨€åŒ…ä¸‹è½½å®Œæˆ"
    } else {
        println "jenkins è®¾ç½®zipè¯­è¨€åŒ…zipFile..."
        zipFileStr = "xxx.zip"
    }

    println ".....$zipFileStr"
    def tempDir = new File(basicPath, "temp_data")
    def delete = tempDir.deleteDir()
    println "æ˜¯å¦æ¸…ç©ºäº†ä¸´æ—¶ç›®å½•?" + delete
    println ""
    tempDir.mkdir()
    def fileTree = zipTree(zipFileStr)
    def files = fileTree.files
    println "è¯­è¨€åŒ…æ–‡ä»¶æ•°é‡ï¼š${files.size()}"
    files.forEach({
        file ->
            def parentFile = file.parentFile
            def name = parentFile.name
            copy {
                from file
                into "${tempDir.path}${File.separator}${name}"
            }
    })
    println "è¯­è¨€åŒ…å·²è§£å‹åˆ°" + tempDir.path
    if (downloadZip) {
        def zipDeleted = zipFile.delete()
        println "åˆ é™¤è¯­è¨€åŒ…?" + zipDeleted
    }

    println ""
    println "è¯­è¨€åŒ…ä¸‹è½½è§£å‹å®Œæˆ"
    return "è¯­è¨€åŒ…ç‰ˆæœ¬: $versionInfo å‘å¸ƒæ—¶é—´:$dateInfo"
}
```
