---
date_created: Monday, July 1st 2020, 10:42:58 pm
date_updated: Thursday, January 30th 2025, 12:09:55 am
title: TraceåŸºç¡€
author: hacket
categories:
  - æ€§èƒ½ä¼˜åŒ–
category: æ€§èƒ½ä¼˜åŒ–å·¥å…·
tags: [Systrace, Trace, æ€§èƒ½ä¼˜åŒ–, æ€§èƒ½ä¼˜åŒ–å·¥å…·]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
date created: 2024-06-07 00:31
date updated: 2024-12-24 00:38
aliases: [Trace åŸºç¡€]
linter-yaml-title-alias: Trace åŸºç¡€
---

# Trace åŸºç¡€

## ä»€ä¹ˆæ˜¯ Traceï¼Ÿ

åœ¨è½¯ä»¶å¼€å‘å’Œæ€§èƒ½è°ƒä¼˜è¿‡ç¨‹ä¸­ï¼Œè¿½è¸ªï¼ˆ`Trace`ï¼‰å·¥å…·è¢«å¹¿æ³›ç”¨äºæ”¶é›†ç¨‹åºè¿è¡Œæ—¶çš„è¯¦ç»†ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©å¼€å‘è€…ç†è§£åº”ç”¨çš„è¡Œä¸ºã€æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œä»è€Œè¿›è¡Œä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿½è¸ªå·¥å…·çš„æ¦‚è¿°ï¼ŒåŒ…æ‹¬ `  Chrome Trace Viewer ` å’Œ `Android` ä¸­çš„è¿½è¸ªå·¥å…·ã€‚

è¿½è¸ªï¼ˆ`Tracing`ï¼‰æ˜¯ä¸€ç§ç›‘æ§å’Œè®°å½•è®¡ç®—æœºç¨‹åºåœ¨è¿è¡Œæ—¶çš„å„ç§æ´»åŠ¨çš„æŠ€æœ¯ã€‚è¿™äº›æ´»åŠ¨å¯ä»¥åŒ…æ‹¬ `å‡½æ•°è°ƒç”¨`ã€`ç³»ç»Ÿè°ƒç”¨`ã€`çº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯`ã€`CPU åˆ©ç”¨ç‡` ç­‰ã€‚é€šè¿‡åˆ†æè¿™äº›è¿½è¸ªæ•°æ®ï¼Œå¼€å‘è€…å¯ä»¥æ·±å…¥ç†è§£ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼Œè¯Šæ–­æ€§èƒ½é—®é¢˜ã€çº¿ç¨‹ç«äº‰ã€æ­»é”ç­‰é—®é¢˜ã€‚

## Trace å·¥å…·

### Chrome Trace Viewer

`Chrome Trace Viewer` æ˜¯ä¸€ä¸ªç”¨äºæŸ¥çœ‹è¿½è¸ªæ•°æ®çš„å·¥å…·ï¼Œå†…ç½®äº Chrome æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ <chrome://tracing> è®¿é—®ã€‚å®ƒä¸ä»…é€‚ç”¨äºå‰ç«¯å¼€å‘è€…åˆ†æç½‘é¡µæ€§èƒ½ï¼Œä¹Ÿé€‚ç”¨äºåˆ†ææ¥è‡ªå…¶ä»–å¹³å°å’Œåº”ç”¨çš„è¿½è¸ªæ•°æ®ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

- `æ”¯æŒå¤šç§æ•°æ®æº`ï¼šChrome Trace Viewer èƒ½å¤„ç†æ¥è‡ª `Chrome`ã€`Android` ç³»ç»Ÿç­‰å¤šç§æ•°æ®æºçš„è¿½è¸ªæ–‡ä»¶ã€‚
- `å›¾å½¢åŒ–ç•Œé¢`ï¼šæä¾›äº†ä¸€ä¸ªç›´è§‚çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œé€šè¿‡æ—¶é—´è½´è¡¨ç¤ºäº‹ä»¶ï¼Œæ–¹ä¾¿åˆ†æã€‚
- `çµæ´»æ€§`ï¼šæ”¯æŒæŒ‰æ—¶é—´ã€çº¿ç¨‹ã€è¿›ç¨‹ç­‰ç»´åº¦è¿‡æ»¤å’ŒæŸ¥çœ‹è¿½è¸ªæ•°æ®ã€‚

> chrome://tracing åœ¨ 2022 å¹´è¿‡æ—¶äº†ï¼Œç°åœ¨æ¨èç”¨ perfetto uiï¼Œ

## Trace é‡‡é›†

Perfetto æ”¶é›† App çš„ Trace æ˜¯é€šè¿‡ Android ç³»ç»Ÿçš„ atrace æ”¶é›†ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨æ·»åŠ  Trace æ”¶é›†ä»£ç ï¼Œæ·»åŠ  Trace é‡‡é›†æ–¹å¼å¦‚ä¸‹ï¼š

- **Java/Kotlin**ï¼šæä¾›äº† `android.os.Trace` ç±»ï¼Œé€šè¿‡åœ¨æ–¹æ³•å¼€å§‹å’Œç»“æŸç‚¹æˆå¯¹æ·»åŠ  `Trace.beginSection` å’Œ `Trace.endSection`ï¼›
- **NDK**ï¼šé€šè¿‡å¼•å…¥ `<trace.h>`ï¼Œé€šè¿‡ `ATrace\_beginSection()` / `Atrace\_endSection()` æ·»åŠ  Traceï¼›
- **Android ç³»ç»Ÿè¿›ç¨‹**ï¼šæä¾›äº† `ATRACE` å®æ·»åŠ  Traceï¼Œå®šä¹‰åœ¨ `libcutils/trace.h`ï¼›

åœ¨ Android Framework å’Œè™šæ‹Ÿæœºå†…éƒ¨ä¼šé»˜è®¤æ·»åŠ ä¸€äº›å…³é”® Traceï¼ŒAPP å±‚éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œç›‘æ§ APP å¯åŠ¨æµç¨‹ï¼Œæœ‰æµ·é‡çš„æ–¹æ³•ï¼Œæ‰‹åŠ¨æ·»åŠ è€—æ—¶è€—åŠ›ã€‚APP å¤§éƒ¨åˆ†é€»è¾‘éƒ½æ˜¯ Java/Kotlin ç¼–å†™ï¼ŒJava/Kotlin ä»£ç ä¼šç¼–è¯‘æˆå­—èŠ‚ç ï¼Œåœ¨ç¼–è¯‘æœŸé—´ï¼Œå¯é€šè¿‡ gradle transform ä¿®æ”¹å­—èŠ‚ç ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€å¥—è‡ªåŠ¨æ’æ¡©çš„ gradle æ’ä»¶ï¼Œåœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨æ·»åŠ  APP å±‚ Trace æ”¶é›†ä»£ç ï¼Œå®ç°ç›‘æ§ APP å±‚æ‰€æœ‰æ–¹æ³•ã€‚

# Android Trace

Android ä¸­æä¾›äº†ä¸¤ç§ trace åˆ†æå·¥å…·ï¼š

- `method trace` æ˜¯æŠ“å–çº¿ç¨‹ä¸­ä»£ç çš„æ‰§è¡Œæ ˆå’Œè€—æ—¶ï¼›
- `systrace` æ˜¯æŠ“å– app ä½¿ç”¨è¿‡ç¨‹ä¸­ cpuã€çº¿ç¨‹å’Œé”é˜»å¡ç­‰ä¿¡æ¯ã€‚

## method trace

é€šè¿‡ `method trace` æŠ“å–çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ–¹æ³•æ ˆå’Œæ–¹æ³•è€—æ—¶ã€‚å¦‚å›¾ï¼Œé€šè¿‡åˆ†æä¸»çº¿ç¨‹çš„æ–¹æ³•è°ƒç”¨ï¼Œè§£å†³ä¸»çº¿ç¨‹è€—æ—¶é€»è¾‘ã€‚

![image.png|900](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian202406070042868.png)

### method trace é‡‡é›†

- æœ¬åœ°å¼€å‘å¿«é€Ÿåˆ†æé—®é¢˜é€šè¿‡ `Debug.startMethodTracingSampling` æ–¹å¼ï¼Œè°ƒè¯•æ•ˆç‡é«˜ã€‚
- é’ˆå¯¹éå¸¸ç»†èŠ‚æ·±åº¦çš„åˆ†æé‡‡ç”¨ `systrace + å‡½æ•°æ’æ¡©` çš„æ–¹å¼ï¼ˆå¯å‚è€ƒï¼š[Gradleæ’ä»¶ç»™ä»£ç åŠ å…¥Trace Tag](https://github.com/AndroidAdvanceWithGeektime/Chapter07)ï¼‰ã€‚

#### Android Studio çš„ Profiler

##### éå¯åŠ¨é˜¶æ®µï¼Œæ‰‹åŠ¨ Record/Stop

é€šè¿‡ Android Studio çš„ Profilerï¼ŒCPU

![image.png|2000](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian202406070044113.png)

##### å¯åŠ¨é˜¶æ®µ

å¯¹äºå¯åŠ¨é˜¶æ®µçš„ method trace éœ€è¦é€šè¿‡é…ç½®æ‰èƒ½å¼€å¯ã€‚

![image.png|2000](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian202406070046456.png)

**è¿™ç§æ–¹å¼ä¼˜ç¼ºç‚¹**

- ä¼˜ç‚¹: ä¸ç”¨å†™ä»£ç è€¦åˆã€‚
- ç¼ºç‚¹: trace æ–‡ä»¶æŠ“å–éœ€è¦é€šè¿‡ `Profile` æ¨¡å¼ï¼Œ`Profile` æ¨¡å¼å¿…é¡»åœ¨ debug æ¨¡å¼ä¸‹æ‰èƒ½è¿›è¡Œï¼Œè€Œ debug å’Œ release æ¨¡å¼åœ¨æ€§èƒ½ä¸Šå·®å¼‚è¾ƒå¤§ï¼Œä¼šè®©é—®é¢˜åˆ†ææœ‰è¾ƒå¤§è¯¯å·®ã€‚

**profile ä¸¤ç§æ¨¡å¼ï¼š**

- `profile app with low overhead`
- `profile app with complete data`

#### é€šè¿‡ä»£ç æŠ“å–

Android ç³»ç»Ÿåœ¨ Java å±‚æä¾›äº†ä¸¤ç§å¼€å‘è€…å¯ç›´æ¥ä½¿ç”¨çš„ Method Trace çš„ APIï¼Œä¸€æ˜¯ `android.os.Debug` ç±»ä¸­çš„ `startMethodTracing` ç›¸å…³ APIï¼Œç¬¬äºŒä¸ªæ˜¯ `android.os.Trace` ç±»ä¸­çš„ `beginSection` ç›¸å…³ APã€‚è¿™ä¸¤è€…çš„åŒºåˆ«æ˜¯ Debug ç±»åªèƒ½ç›‘æ§ Java å‡½æ•°è°ƒç”¨ï¼Œè€Œ Trace ç±»åº•å±‚æ˜¯ä½¿ç”¨ [atrace](https://perfetto.dev/docs/data-sources/atrace) å®ç°ï¼Œå…¶è¿½è¸ªçš„å‡½æ•°ä¼šåŒ…å«äº†åº”ç”¨åŠç³»ç»Ÿçš„ Java å’Œ Native å‡½æ•°ï¼Œå¹¶ä¸”åº•å±‚åŸºäº `ftrace` è¿˜å¯ä»¥è¿½è¸ª cpu çš„è¯¦ç»†æ´»åŠ¨ä¿¡æ¯ã€‚

**Debug ç±»ï¼š**
åœ¨ app å¯åŠ¨çš„æ—¶å€™ `startMethodTracingSampling`ï¼Œé¦–é¡µåŠ è½½å®Œæˆå `stopMethodTracing`ï¼Œç„¶åä¼šç”Ÿæˆ trace æ–‡ä»¶ï¼Œå°†æ‰‹æœºä¸­çš„ trace æ–‡ä»¶å¯¼å‡ºåˆ°ç”µè„‘ä¸Šï¼Œé€šè¿‡ profile çª—å£æ‰“å¼€

```java
// æ–¹å¼1
Debug.startMethodTracing() // é»˜è®¤è·¯å¾„ï¼š/sdcar/Android/data/åŒ…å/files/dmtrace.trace
Debug.stopMethodTracing()

// æ–¹å¼2
Debug.startMethodTracingSampling(traceName, 0, sampleInterval);
Debug.stopMethodTracing();
```

**è¿™ç§æ–¹å¼ä¼˜ç¼ºç‚¹**

- ä¼˜ç‚¹: trace æ–‡ä»¶ debug å’Œ release æ¨¡å¼éƒ½å¯ä»¥æŠ“å–ï¼Œrelease æ¨¡å¼æŠ“å–çš„æ–‡ä»¶åˆ†æè€—æ—¶æ›´åŠ å‡†ç¡®ã€‚
- ç¼ºç‚¹: éœ€è¦åœ¨å·¥ç¨‹ä¸­æ·»åŠ ä»£ç ï¼Œä½†æ˜¯ä»£ç é‡è¾ƒå°‘ã€‚

> é€šè¿‡ä»£ç æ¨¡å¼ä¸‹çš„ release æ¨¡å¼ method trace å…¶å®å¯¹æ€§èƒ½å½±å“è¿˜å¥½ï¼Œä½ç«¯æœºä¸‹å¼€å¯ method trace åæ•´ä½“å¯åŠ¨è€—æ—¶ä»…å¢é•¿ 300msã€‚

**Trace ç±»**

```kotlin
binding.btnNativeThreadUpdateUi.setOnClickListener {
	try {
		Trace.beginSection("btnNativeThreadUpdateUi")
		val nativeThreadTest = NativeThreadTest(this)
		SystemClock.sleep(2453L)
//            nativeThreadTest.createNativeThread()
	} finally {
		Trace.endSection()
	}
}
```

#### method trace åº”ç”¨

- æŸ¥çœ‹çº¿ç¨‹ã€æ–¹æ³•å‡½æ•°è€—æ—¶
- æŸ¥çœ‹æ–¹æ³•è°ƒç”¨æ—¶åº

##### å…·ä½“æ¡ˆä¾‹

åœ¨ APM ç³»ç»Ÿä¸­ å½“æˆ‘ä»¬ç›‘æµ‹åˆ° APP æ…¢å¯åŠ¨ã€æ…¢æ¶ˆæ¯å¤„ç†ã€é¡µé¢æ…¢å¯åŠ¨ã€ANR æ—¶ï¼Œå¾ˆå¤šæƒ…å†µä¸‹åªèƒ½æ‹¿åˆ°æœ€åæ—¶åˆ»çš„ä¸€äº›ä¿¡æ¯ï¼Œæˆ–è€…æ˜¯ä¸€äº›ç®€å•çš„æµç¨‹è€—æ—¶ï¼Œæ²¡æ³•æ„ŸçŸ¥å…·ä½“ä¸»çº¿ç¨‹åœ¨è¿™é˜¶æ®µå‡½æ•°æ‰§è¡Œçš„æƒ…å†µï¼Œ é€šè¿‡è¡¥é½ methodTrace ä¿¡æ¯ï¼Œå°†ä¸Šè¿°æ€§èƒ½é—®é¢˜å‘ç”Ÿæ—¶é—´æ®µçš„ å †æ ˆæ ·æœ¬ä¸€èµ·ä¸ŠæŠ¥ï¼Œä¹‹åï¼Œåœ¨ APM å¹³å°ä¸Šï¼Œåˆ†æå…·ä½“é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬æä¾›äº†å±•ç¤ºæ€§èƒ½é—®é¢˜å‘ç”Ÿæ—¶é—´æ®µçš„ç«ç„°å›¾ã€‚ è¿™é‡Œä»¥åº”ç”¨å¯åŠ¨ç›‘æ§åŠŸèƒ½ä¸ºä¾‹ï¼Œå¯¹äºæ…¢å¯åŠ¨çš„æ—¥å¿—æ ·æœ¬ï¼Œå¯ä»¥å±•ç¤ºå‡ºå¯¹äºçš„ç«ç„°å›¾ä¿¡æ¯

##### å¡é¡¿ç›‘æ§æ¡ˆä¾‹åˆ†äº«

åœ¨çº¿ä¸‹åœºæ™¯ä¸­ï¼Œä»¥å¡é¡¿ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯èƒ½æ›´å¸Œæœ›å‘ç”Ÿå¡é¡¿ä¹‹åï¼Œèƒ½å¤Ÿç«‹å³å—åˆ°é€šçŸ¥ï¼Œç‚¹å‡»é€šçŸ¥æ—¶ï¼Œèƒ½å¤Ÿåœ¨æ‰‹æœºä¸Šä»¥ç«ç„°å›¾çš„å½¢å¼ ç›´æ¥å±•ç¤ºå¡é¡¿æ—¶é—´æ®µçš„å †æ ˆã€‚

- [GitHub - Knight-ZXW/BlockCanaryX: ğŸ”¥åŸºäºå †æ ˆé‡‡æ ·ï¼Œä½¿ç”¨å‡½æ•°ç«ç„°å›¾çš„å½¢å¼å±•ç¤ºAndroid Main Looperçš„æ…¢æ¶ˆæ¯å¤„ç†è¿‡ç¨‹ï¼Œå®šä½é˜»å¡åŸå› ](https://github.com/Knight-ZXW/BlockCanaryX)

åŸºäº Thread.getStackTrace çš„å®ç°æ–¹æ¡ˆæ€§èƒ½å½±å“è¾ƒå¤§ï¼Œ å­—èŠ‚è·³åŠ¨åˆ†äº«äº†ä¸€ä¸ªé€šè¿‡ è°ƒç”¨ [StackVisitor](https://blog.csdn.net/ByteDanceTech/article/details/119621240) æ¥å®ç°å‡½æ•°é‡‡æ ·çš„æ–¹æ¡ˆ

##### ç½‘ç»œæ•°æ®è§£æè€—æ—¶

é€šè¿‡ method trace æ’æŸ¥å¯åŠ¨è¿‡ç¨‹ä¸­ç›¸å…³çš„è€—æ—¶ä»»åŠ¡ï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„åœºæ™¯ï¼Œç½‘ç»œæ•°æ®è¯·æ±‚è¿”å›åä¸»çº¿ç¨‹è§£ææ•°æ®ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ”¾åˆ°å¼‚æ­¥ä¸­æ‰§è¡Œã€‚

![image.png|1500](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian202406270038752.png)

##### å¸ƒå±€è§£æè€—æ—¶

é€šè¿‡å¯åŠ¨é¢„åŠ è½½ï¼Œå¼‚æ­¥åˆ›å»ºé¦–é¡µå¸ƒå±€ã€‚

![image.png|1500](https://raw.githubusercontent.com/hacket/ObsidianOSS/master/obsidian202406270043303.png)

#### ç³»ç»Ÿ method trace å®ç°åŸç†

- [Android å¹³å°ä¸‹çš„ Method Traceå®ç°è§£æ åŠ å¡é¡¿ç›‘æµ‹å®è·µ](https://blog.csdn.net/zhuoxiuwu/article/details/125451794)

## `Systrace`

## Perfetto

# Trace åˆ†æ

## Android Studio Profiler Trace åˆ†æ

[[Android Studio Profilerå…¥é—¨#Android Studio Profiler åˆ†æ method trace]]

## è‡ªåŠ¨åŒ–åˆ†æ

**Perfetto æä¾›äº†å¼ºå¤§çš„ Trace åˆ†ææ¨¡å—**ï¼š`Trace Processor`ï¼ŒæŠŠå¤šç§ç±»å‹çš„æ—¥å¿—æ–‡ä»¶ï¼ˆ`Android systrace`ã€`Perfetto`ã€`linux ftrace`ï¼‰é€šè¿‡è§£æã€æå–å…¶ä¸­çš„æ•°æ®ï¼Œç»“æ„åŒ–ä¸º SQLite æ•°æ®åº“ï¼Œå¹¶ä¸”æä¾›åŸºäº SQL æŸ¥è¯¢çš„ python APIï¼Œå¯é€šè¿‡ python å®ç°è‡ªåŠ¨åŒ–åˆ†æã€‚

ä¸ºæé«˜æ•ˆç‡ï¼Œéœ€åŸºäº `Trace Processor` çš„ python APIï¼Œå¼€å‘ä¸€å¥— Trace è‡ªåŠ¨åˆ†æå·¥å…·é›†ï¼Œå®ç°å¿«é€Ÿé«˜æ•ˆåˆ†æç‰ˆæœ¬å¯åŠ¨åŠ£åŒ–é—®é¢˜ã€‚
