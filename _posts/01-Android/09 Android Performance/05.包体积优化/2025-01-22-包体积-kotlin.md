---
date_created: Wednesday, January 22nd 2025, 7:55:08 pm
date_updated: Wednesday, January 22nd 2025, 7:56:49 pm
title: 包体积-kotlin
author: hacket
categories:
  - 性能优化
category: 包体积
tags: [包体积, 性能优化]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
aliases: [包体积]
linter-yaml-title-alias: 包体积
---

# 包体积

- 不用 data class ，用普通的 class
- 自定义 ViewModel 的 lazy 实现？待验证

## 自定义 ViewModel 的 Lazy

```kotlin
@MainThread
inline fun <reified VM : ViewModel> Fragment.defaultActivityViewModels(
): Lazy<VM> = DefaultFragmentViewModelLazy(
    VM::class,this,needRequestActivity = true
)

class DefaultFragmentViewModelLazy<VM : ViewModel> (
    private val viewModelClass: KClass<VM>,
    private val fragment: Fragment,
    private val needRequestActivity: Boolean = false
) : Lazy<VM> {
    private var cached: VM? = null

    override val value: VM
        get() {
            val viewModel = cached
            return if (viewModel == null) {
                val factory = if(needRequestActivity) fragment.requireActivity().defaultViewModelProviderFactory else fragment.defaultViewModelProviderFactory
                val store = if(needRequestActivity) fragment.requireActivity().viewModelStore else fragment.viewModelStore
                ViewModelProvider(
                    store,
                    factory,
                    if(needRequestActivity) fragment.requireActivity().defaultViewModelCreationExtras else fragment.defaultViewModelCreationExtras
                ).get(viewModelClass.java).also {
                    cached = it
                }
            } else {
                viewModel
            }
        }

    override fun isInitialized(): Boolean = cached != null
}

class DefaultViewModelLazy<VM : ViewModel> (
    private val viewModelClass: KClass<VM>,
    private val storeProducer: ViewModelStore,
    private val factoryProducer: Factory,
    private val extrasProducer: CreationExtras
) : Lazy<VM> {
    private var cached: VM? = null

    override val value: VM
        get() {
            val viewModel = cached
            return if (viewModel == null) {
                val factory = factoryProducer
                val store = storeProducer
                ViewModelProvider(
                    store,
                    factory,
                    extrasProducer
                ).get(viewModelClass.java).also {
                    cached = it
                }
            } else {
                viewModel
            }
        }

    override fun isInitialized(): Boolean = cached != null
}

inline fun <reified VM : ViewModel> Fragment.defaultViewModels(): Lazy<VM> {
    return DefaultFragmentViewModelLazy(VM::class,this)
}

inline fun <reified VM : ViewModel> ComponentActivity.defaultViewModels(): Lazy<VM> {
    return DefaultViewModelLazy(VM::class, viewModelStore , defaultViewModelProviderFactory, defaultViewModelCreationExtras)
}
```
