---
date_created: Friday, February 23rd 2019, 10:10:45 pm
date_updated: Tuesday, January 21st 2025, 12:31:34 am
title: 字节码总结
author: hacket
categories:
  - Android进阶
category: 字节码
tags: [字节码, ASM]
toc: true
description: 
dg-publish: true
dg-enable-search: true
dg-show-local-graph: true
dg-show-toc: true
dg-show-file-tree: true
image-auto-upload: true
feed: show
format: list
date created: 2024-12-24 00:30
date updated: 2024-12-29 22:57
aliases: [字节码基础]
linter-yaml-title-alias: 字节码基础
---

# 字节码基础

## 字节码文件中具体保存了哪些东西？

![image.png](https://cdn.nlark.com/yuque/0/2022/png/694278/1654448389750-092be6bf-a6b0-4114-98e5-4fb61930eb10.png#averageHue=%23f6f6f6&clientId=ud4d60f4f-e76f-4&from=paste&height=365&id=u7df2f25a&originHeight=956&originWidth=1125&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76299&status=done&style=none&taskId=u46e467c3-0102-4419-8fb3-0294b57a497&title=&width=429)

## JVM 之 class 加载过程

![image.png](https://cdn.nlark.com/yuque/0/2022/png/694278/1654966674219-a08d79be-4dae-4867-abd3-ed2084167661.png#averageHue=%23fafafa&clientId=uf9aca7f5-fdec-4&from=paste&height=155&id=u766e4ce2&originHeight=420&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63475&status=done&style=none&taskId=u39092600-7d2f-4c25-80e0-bc81e839c68&title=&width=431)<br />虚拟机把描述类的数据从 Class 文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的 Java 类型，这就是虚拟机的 _ 类加载机制。

# ASM 字节码插桩框架

## ASM 工作在哪个阶段？

![](https://cdn.nlark.com/yuque/0/2022/webp/694278/1658756875783-1ce3b265-5340-4de2-a00d-df3aa222efb0.webp#averageHue=%2358473b&clientId=u41c94535-544e-4&from=paste&id=u8acdccc9&originHeight=398&originWidth=1033&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uaac86da5-f932-4bcc-8a5e-1714893f0b4&title=)

1. 在.java 文件编译成.class 文件时，APT 工作在这个阶段
2. 在.class 文件进一步优化成.dex 文件时，ASM 工作在这个阶段

## ASM API

### ASM Tree API 对象模型

> 一次性读入内存，类似 XML 文件解析中的 DOM 方式；耗内存

ASM Tree API 可以类比解析 XML 文件中的 DOM 方式，把整个类的结构读取到内存中，缺点是消耗内存多，但是编程比较简单。TreeApi 不同于 CoreAPI，TreeAPI 通过各种 Node 类来映射字节码的各个区域，类比 DOM 节点，就可以很好地理解这种编程方式。

ClassReader/ClassWriter

### ASM Core API 事件模型（常见）

> 流式处理字节码文件，类型 XML 文件解析中的 SAX 方式；节约内存

ASM Core API 可以类比解析 XML 文件中的 SAX 方式，不需要把这个类的整个结构读取进来，就可以用流式的方法来处理字节码文件。好处是非常节约内存，但是编程难度较大。然而出于性能考虑，一般情况下编程都使用 Core API。<br />ClassReader、ClassWriter 和各种 Visitor 类（访问者模式）

# 字节码面试题

## 字节码相关 INVOKEVIRTUAL INVOKESPECIAL INVOKESTATIC 之间的区别

1. INVOKEVIRTUAL 调用类的方法
2. INVOKESPECIAL 调用父类
3. INVOKESTATIC 调用静态方法

## 用 ASM 在项目都做了哪些事情？

### Transform+ASM 实现指定方法的 try catch，可用于修复三方 sdk 的 crash

### 输出方法执行耗时

可用于分析 ui-thread 方法耗时情况

### 隐私合规方法检测

1. 扫描 dex 找到在隐私列表中的 api，打印出来，并将调用替换掉 `""`、`null` 或 `emptyList()`。
2. 如 getImei，getDeviceId(), wifi 等
